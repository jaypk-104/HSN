/*
 * File: app/controller/MyGridController.js
 *
 * This file was generated by Sencha Architect version 4.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('M_GR_PRINT.controller.MyGridController', {
    extend: 'Ext.app.Controller',

    stores: [
        'MyStore'
    ],

    control: {
        "#gridAddBtn": {
            click: 'gridAddBtnClick'
        },
        "#gridDelBtn": {
            click: 'gridDelBtnClick'
        },
        "#xlsxDown": {
            click: 'xlsxDownClick'
        },
        "#xmlDown": {
            click: 'xmlDownClick'
        },
        "#printBtn": {
        	click: 'printBtnClick'
        }
    },

    gridAddBtnClick: function(button, e, eOpts) {
        //var popup = Ext.create("B_COMP_HSPF.view.WinAddRow");
        //popup.show();
        //Ext.getCmp('rowCount').setValue(1);
    },

    gridDelBtnClick: function(button, e, eOpts) {
        var store = Ext.getStore('MyStore');
            	var gridRecord = Ext.getCmp('myGrid').getSelectionModel().getSelection();

            	if(gridRecord.length > 0) {
            		Ext.Msg.confirm('확인','삭제하시겠습니까?', function(button){
            			if(button == 'yes') {
            				for(var i=0; i<gridRecord.length; i++) {
            		    		if(gridRecord[i].data['V_TYPE']=='V') {
            		    			gridRecord[i].data['V_TYPE'] = 'D';
            		    		}
            		    	}
            		    	store.sync({
            					params: {
            						V_USR_ID : 'admin',//parent.Ext.getCmp('GUSER_ID').getValue(),
            					},
            		    		callback: function(records, operation, success) {
            		    			store.reload();
            					}
            		    	});
            			}
            		});
            	}
    },

    xlsxDownClick: function(button, e, eOpts) {
        var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
            	var grid = Ext.getCmp('myGrid');
            	grid.saveDocumentAs({
                    type: 'xlsx',
                    title: 'test', //엑셀내타이틀
                    fileName: currentDate+'.xlsx' //엑셀파일이름
        		});
    },

    xmlDownClick: function(button, e, eOpts) {
        var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
            	var grid = Ext.getCmp('myGrid');
            	grid.saveDocumentAs({
                    type: 'xml',
                    title: 'test', //엑셀내타이틀
                    fileName: currentDate+'.xml' //엑셀파일이름
        		});
    },
    
    printBtnClick: function(button, e, eOpts) {
    	var grid = Ext.getCmp('myGrid');
        var gridRecord = grid.getSelectionModel().getSelection();
        var store = grid.getStore();
        if(gridRecord.length >= 1){
        	var yCount = 0;
        	for( var i = 0 ; i < gridRecord.length ; i++ ){
        		if(gridRecord[i].data['PRINT_YN'] == 'Y'){
        			yCount++;
        		}
        	}
        	
        	if(yCount == 0){
        		Ext.Msg.confirm('확인','새 입고지시서를 만드시겠습니까?',
    				function(button){
            	    	if(button=='yes') {
            	    		Ext.Ajax.request({
            	    			url:'sql/m_gr_print.jsp',
            	    			method: 'post',
            	    			params: {
            	    				V_TYPE: 'N',
            	    				V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
            	    				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
            	    			},
            	    			success : function(response) {
            	    				var jsonResult = Ext.JSON.decode(response.responseText);
            	    				var V_MD_NO = jsonResult[0].V_MD_NO;
//            	    				console.log(jsonResult[0].V_MD_NO);
            	    				for( var i = 0 ; i < gridRecord.length ; i++ ){
            	    					if(gridRecord[i].data['V_TYPE'] == 'V'){
            	    						gridRecord[i].set('V_TYPE', 'I');
            	    					}
            	    				}
            	    				store.sync({
            	    					params: {
            	    						V_TYPE : 'I',
            	    						V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
            	    	    				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
            	    	    				V_MD_NO : V_MD_NO,
            	    					},
            	    					callback: function(records,operations,success){
            	    						store.reload();
            	    						var myWin=new Ext.Window(
            	    								{
            	    									title : '입고지시서',
            	    									html : '<iframe name="xxx" border =0 src="http://123.142.124.170:8080/aireport/on_server/GR_PRINT.jsp?PRINT_NO='+V_MD_NO+'&V_USR_ID='+parent.Ext.getCmp('GUSER_ID').getValue()+'" width="100%" height="100%"></iframe>',
            	    									width :1000,
            	    									height:768,
            	    									modal: true
            	    								});
            	    						myWin.show();
            	    						myWin.setSize(Ext.getBody().getViewSize());
            	    						myWin.setPagePosition(0, 0);
            	    					}
            	    				});
            	    			}
            	            });
            	    	}
        		});
        	}// yCount == 0 끝
        	else if (yCount != gridRecord.length){
        		//발행유무가 Y와 N이 섞여있는경우
        		Ext.Msg.alert('확인', '선택한 목록을 다시 확인해주세요.');
        	}
        	else{
        		var difFlag = 0;
        		var printNo = gridRecord[0].data['PRINT_NO'];
        		for( var i = 0 ; i < gridRecord.length ; i++ ){
            		if(gridRecord[i].data['PRINT_NO'] != printNo){
            			difFlag = 1;
            		}
            	}
        		if( difFlag == 1){
        			// 여러개 선택되어있는데 입고지시번호가 다른경우
        			Ext.Msg.alert('확인', '지시번호가 다른 목록이 존재합니다.');
        		}
        		else{
        			var myWin=new Ext.Window(
							{
								title : '입고지시서',
								html : '<iframe name="xxx" border =0 src="http://123.142.124.170:8080/aireport/on_server/GR_PRINT.jsp?PRINT_NO='+printNo+'&V_USR_ID='+parent.Ext.getCmp('GUSER_ID').getValue()+'" width="100%" height="100%"></iframe>',
								width :1000,
								height:768,
								modal: true
							});
					myWin.show();
					myWin.setSize(Ext.getBody().getViewSize());
					myWin.setPagePosition(0, 0);
        		}
        	}
        	
        }
        else{
        	Ext.Msg.alert('확인', '목록을 선택하고 버튼을 눌러주세요.');
        }
    	
    }

});
