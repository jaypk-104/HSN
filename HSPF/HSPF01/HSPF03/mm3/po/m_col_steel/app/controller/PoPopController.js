/*
 * File: app/controller/RPoRegController.js
 *
 * This file was generated by Sencha Architect version 4.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('M_COL_STEEL.controller.PoPopController', {
    extend: 'Ext.app.Controller',
	stores : [ 'MyStore', 'PopStore'],
	control : {
		"#w_poSelBtn" : {
			click : 'w_poSelBtnClick'
		},
		'#w_poRegBtn' : {
			click : 'w_poRegBtnClick'
		},
		'#popGrid': {
			celldblclick: 'w_popGridDblClick'
		},
		"textfield[name=po_search]": {
            specialkey: 'tfEnter'
        }
	},
	
	w_poSelBtnClick: function() {
		var popStore = this.getPopStoreStore();
		popStore.load({
    		params: {
    			V_TYPE: 'O',
    			V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
				V_BS_DT_FR : Ext.getCmp('V_PO_DT_FR').getValue(),
				V_BS_DT_TO : Ext.getCmp('V_PO_DT_TO').getValue(),
				V_M_BP_NM : Ext.getCmp('W_M_BP_NM').getValue(),
				V_APPROV_NO : Ext.getCmp('W_APPROV_NO').getValue(),
				V_PO_NO : Ext.getCmp('W_PO_NO').getValue(),
    		},
    		callback: function(records,operations,success){
    		}
    	});
	},
	
	w_poRegBtnClick: function() {
		var w_gridRecord = Ext.getCmp('PopGrid').getSelectionModel().getSelection();
		var store = Ext.getStore('MyStore');
		
		if(w_gridRecord.length == 1) {
			
			var tbController = M_COL_STEEL.app.getController("TbButtonController");
    		tbController.clrBtnClick();
			
			Ext.getCmp('V_PO_NO').setValue(w_gridRecord[0].data['PO_NO']);
			Ext.getCmp('V_M_BP_NM').setValue(w_gridRecord[0].data['M_BP_NM']);
			Ext.getCmp('V_M_BP_CD').setValue(w_gridRecord[0].data['M_BP_CD']);
			Ext.getCmp('V_S_BP_NM').setValue(w_gridRecord[0].data['S_BP_NM']);
			Ext.getCmp('V_S_BP_CD').setValue(w_gridRecord[0].data['S_BP_CD']);
			Ext.getCmp('V_APPROV_NO').setValue(w_gridRecord[0].data['APPROV_NO']);
			Ext.getCmp('V_COL_TITLE').setValue(w_gridRecord[0].data['APPROV_NM']);
			Ext.getCmp('V_COL_MGM_NO').setValue(w_gridRecord[0].data['COL_MGM_NO']);
			
			store.load({
				params: {
					V_TYPE: 'SH2',
					V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
					V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
					V_MAST_DB_NO : Ext.getCmp('V_MAST_DB_NO').getValue(),
					V_PO_NO : Ext.getCmp('V_PO_NO').getValue(),
				},
				callback: function(records){
					Ext.getCmp('BO_JAN_AMT').setValue('');
					Ext.getCmp('BU_JAN_AMT').setValue('');
					Ext.getCmp('LOAD_YN').setValue('N');
					
					Ext.getCmp('saveBtn').setDisabled(false);
				}
			});
	    	
		} else {
			Ext.Msg.alert('발주를 선택하세요.');
		}
		
		var popWin=  Ext.getCmp('WinPoPop');
		popWin.destroy();
	},
	w_popGridDblClick : function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
		
		var tbController = M_COL_STEEL.app.getController("TbButtonController");
		tbController.clrBtnClick();
		
		Ext.getCmp('V_PO_NO').setValue(record.get('PO_NO'));
		Ext.getCmp('V_M_BP_NM').setValue(record.get('M_BP_NM'));
		Ext.getCmp('V_M_BP_CD').setValue(record.get('M_BP_CD'));
		Ext.getCmp('V_S_BP_NM').setValue(record.get('S_BP_NM'));
		Ext.getCmp('V_S_BP_CD').setValue(record.get('S_BP_CD'));
		Ext.getCmp('V_APPROV_NO').setValue(record.get('APPROV_NO'));
		Ext.getCmp('V_COL_TITLE').setValue(record.get('APPROV_NM'));
		Ext.getCmp('V_COL_MGM_NO').setValue(record.get('COL_MGM_NO'));
		
    	var store = this.getMyStoreStore();
    	store.removeAll();
    	
    	Ext.getCmp('BO_JAN_AMT').setValue('');
		Ext.getCmp('BU_JAN_AMT').setValue('');
		Ext.getCmp('LOAD_YN').setValue('N');
		
      	Ext.Ajax.request({
			url : 'sql/M_COL_STEEL.jsp',
			method : 'post',
			params: {
				V_TYPE: 'ID',
				V_PO_NO : record.get('PO_NO'),
				V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
			},
			success: function(response) {

				store.load({
					params: {
						V_TYPE: 'SH2',
						V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
						V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
						V_MAST_DB_NO : Ext.getCmp('V_MAST_DB_NO').getValue(),
						V_PO_NO : Ext.getCmp('V_PO_NO').getValue(),
					},
					callback: function(records){
						Ext.getCmp('BO_JAN_AMT').setValue('');
						Ext.getCmp('BU_JAN_AMT').setValue('');
						Ext.getCmp('LOAD_YN').setValue('N');
						
						Ext.getCmp('saveBtn').setDisabled(false);
					}
				});
			}
		});
		
		var popWin=  Ext.getCmp('WinPoPop');
		popWin.destroy();
	},
	
	tfEnter: function(field, e, eOpts) {
    	if (e.getKey() == e.ENTER) {
    		this.w_poSelBtnClick();
    	}
}

});
