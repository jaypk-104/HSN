/*
 * File: app/controller/WinAddRowController.js
 *
 * This file was generated by Sencha Architect version 4.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('A_AR_RECEIPT2.controller.WinPopController', {
	extend : 'Ext.app.Controller',
	stores : [ 'PopStore', 'PopStore1', 'PopStore2' ],

	control : {
		"#w_selBtn" : {
			click : 'w_selBtnClick'
		},
		'#w_regBtn' : {
			click : 'w_regBtnClick'
		},
		'#popGrid' : {
			celldblclick : 'w_popGridDblClick',
			cellclick : 'w_popGridClick',
		},

		"#w_selBtn1" : {
			click : 'w_selBtn1Click'
		},
		'#w_regBtn1' : {
			click : 'w_regBtn1Click'
		},
		'#popGrid1' : {
			celldblclick : 'w_popGrid1DblClick'
		},

		"#w_selBtn2" : {
			click : 'w_selBtn2Click'
		},
		'#w_regBtn2' : {
			click : 'w_regBtn2Click'
		},
		'#popGrid2' : {
			celldblclick : 'w_popGrid2DblClick'
		},
	},

	w_selBtnClick : function(button, e, eOpts) {
		var popStore = this.getPopStoreStore();
		popStore.load({
			params : {
				V_TYPE : 'RP',
				V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
				V_AR_TYPE : Ext.getCmp('W_AR_TYPE').getValue(),
				V_DT_FR : Ext.getCmp('W_AR_DT_FR').getValue(),
				V_DT_TO : Ext.getCmp('W_AR_DT_TO').getValue(),
				V_DEPT_CD : Ext.getCmp('W_DEPT_CD').getValue(),
				V_BP_CD : Ext.getCmp('W_BP_CD').getValue(),
			},
			callback : function(records, operations, success) {
			}
		});
	},

	w_regBtnClick : function(button, e, eOpts) {
		var store1 = Ext.getStore('MyStore1');
		var popGrid = Ext.getCmp('popGrid').getSelection();
		var count = store1.getCount();
		var flag = 'T';
		var msg = '';
		var totalRemainAmt = 0;
		
		for (var i = 0; i < popGrid.length; i++) {
			var selectedArNo = popGrid[i].get('AR_NO');
			totalRemainAmt += popGrid[i].get('BAL_LOC_AMT');
			store1.each(function(rec, idx) {
				var storeArNo = rec.get('AR_NO');
				if (selectedArNo == storeArNo) {
					flag = 'F';
					msg = '동일한 채권번호가 이미 존재합니다.';
					return;
				}
			});
		}

		if (flag == 'F') {
			Ext.Msg.alert('확인', msg);
			return;
		}
		
		if(totalRemainAmt == 0){
			Ext.Msg.alert('확인', '선택된 잔액이 모두 0원 입니다.');
			return;
		}

		for (var i = 0; i < popGrid.length; i++) {
			var record = popGrid[i];
			
			if(record.get('BAL_LOC_AMT') == 0) continue;
			
			count += 1;
			var rec = Ext.create('A_AR_RECEIPT2.model.MyModel', {
				V_TYPE : 'I',
				AR_TYPE : record.get('AR_TYPE'),
				AR_NO : record.get('AR_NO'),
				AR_DT : record.get('AR_DT'),
				BP_CD : record.get('S_BP_CD'),
				BP_NM : record.get('BP_NM'),
				ACCT_CD : record.get('ACCT_CD'),
				ACCT_NM : record.get('ACCT_NM'),
				DEPT_CD : record.get('DEPT_CD'),
				DEPT_NM : record.get('DEPT_NM'),
				CUR : record.get('CUR'),
				XCH_RATE : record.get('XCH_RATE'),
				DOC_AMT : record.get('DOC_AMT'),
				LOC_AMT : record.get('LOC_AMT'),
				REMAIN_AMT : record.get('BAL_LOC_AMT'),
				REMAIN_DOC_AMT : record.get('BAL_LOC_AMT'),
				REMAIN_LOC_AMT : record.get('BAL_LOC_AMT'),
				REMARK : record.get('REMARK'),
			});

			store1.insert(store1.getCount() - 1, rec);
		}
		
		Ext.getCmp('V_CLS_TYPE').setValue('B');

		var selModel = Ext.getCmp('myGrid1').getSelectionModel();
		selModel.selectAll();

		var popStore = this.getPopStoreStore();
		popStore.removeAll();

		var popWin = button.up().up();
		popWin.destroy();
	},

	w_popGridDblClick : function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
		var store1 = Ext.getStore('MyStore1');
		var flag = 'T';
		var msg = '';

		var selectedArNo = record.get('AR_NO');
		store1.each(function(rec, idx) {
			var storeArNo = rec.get('AR_NO');
			if (selectedArNo == storeArNo) {
				flag = 'F';
				msg = '동일한 채권번호가 이미 존재합니다.';
				return;
			}
		});
		
		if(record.get('BAL_LOC_AMT') == 0){
			flag = 'F';
			msg = '잔액이 0원 입니다.';
		}

		if (flag == 'F') {
			Ext.Msg.alert('확인', msg);
			return;
		}

		var rec = Ext.create('A_AR_RECEIPT2.model.MyModel', {
			V_TYPE : 'I',
			AR_TYPE : record.get('AR_TYPE'),
			AR_NO : record.get('AR_NO'),
			AR_DT : record.get('AR_DT'),
			BP_CD : record.get('S_BP_CD'),
			BP_NM : record.get('BP_NM'),
			ACCT_CD : record.get('ACCT_CD'),
			ACCT_NM : record.get('ACCT_NM'),
			DEPT_CD : record.get('DEPT_CD'),
			DEPT_NM : record.get('DEPT_NM'),
			CUR : record.get('CUR'),
			XCH_RATE : record.get('XCH_RATE'),
			DOC_AMT : record.get('DOC_AMT'),
			LOC_AMT : record.get('LOC_AMT'),
			REMAIN_AMT : record.get('BAL_LOC_AMT'),
			REMAIN_DOC_AMT : record.get('BAL_LOC_AMT'),
			REMAIN_LOC_AMT : record.get('BAL_LOC_AMT'),
			REMARK : record.get('REMARK'),
		});

		store1.insert(store1.getCount() - 1, rec);
		
		Ext.getCmp('V_CLS_TYPE').setValue('B');

		var selModel = Ext.getCmp('myGrid1').getSelectionModel();
		selModel.selectAll();

		var popStore = this.getPopStoreStore();
		popStore.removeAll();

		var popWin = tableview.up().up();
		popWin.destroy();
	},
	
	w_popGridClick : function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
		var gridRecord = Ext.getCmp('popGrid').getSelectionModel().getSelection();
		var store1 = Ext.getStore('MyStore1');
		var selectedAmt = 0;
		var totArAmt = 0;
		var remainAmt = 0;
		
    	for(var i in gridRecord){
    		selectedAmt += Number(gridRecord[i].get('BAL_LOC_AMT'));
    	}
    	
    	store1.each(function(rec, idx) {
        	totArAmt += rec.get('REMAIN_AMT');
		});
    	
    	remainAmt = Ext.getCmp('W_TOT_AMT').getValue() - selectedAmt - totArAmt;
    	Ext.getCmp('W_REMAIN_AMT').setValue(remainAmt);
	},

	tfEnter : function(field, e, eOpts) {
		if (e.getKey() == e.ENTER) {
			this.w_selBtnClick();
		}
	},

	w_selBtn1Click : function(button, e, eOpts) {
		var popStore1 = this.getPopStore1Store();
		popStore1.load({
			params : {
				V_TYPE : 'SP',
				V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
				V_CLS_DT_FR : Ext.getCmp('W_CLS_DT_FR').getValue(),
				V_CLS_DT_TO : Ext.getCmp('W_CLS_DT_TO').getValue(),
				V_DT_FR : Ext.getCmp('W_AR_DT_FR2').getValue(),
				V_DT_TO : Ext.getCmp('W_AR_DT_TO2').getValue(),
				V_DEPT_CD : Ext.getCmp('W_DEPT_CD2').getValue(),
				V_BP_CD : Ext.getCmp('W_BP_CD2').getValue(),
			},
			callback : function(records, operations, success) {
			}
		});
	},

	w_regBtn1Click : function(button, e, eOpts) {
		var record = Ext.getCmp('popGrid1').getSelection()[0];
		if (!!record)
			this.w_popGrid1DblClick(button, '', '', record, '', '', '', '');
	},

	w_popGrid1DblClick : function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
		Ext.getCmp('V_CLS_AR_NO').setValue(record.get('CLS_AR_NO'));

		var tbController = A_AR_RECEIPT2.app.getController("TbButtonController");
		tbController.selBtnClick();

		var popStore1 = this.getPopStore1Store();
		popStore1.removeAll();

		var popWin = tableview.up().up();
		popWin.destroy();
	},

	w_selBtn2Click : function(button, e, eOpts) {
		var popStore2 = this.getPopStore2Store();
		popStore2.load({
			params : {
				V_TYPE : 'ACCT_POP',
				V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
				V_ACCT_CD : Ext.getCmp('W_ACCT_CD').getValue(),
				V_ACCT_NM : Ext.getCmp('W_ACCT_NM').getValue(),
			},
			callback : function(records, operations, success) {
			}
		});
	},

	w_regBtn2Click : function(button, e, eOpts) {
		var record = Ext.getCmp('popGrid2').getSelection()[0];
		if (!!record)
			this.w_popGrid2DblClick(button, '', '', record, '', '', '', '');
	},

	w_popGrid2DblClick : function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
		var selectedRecord = Ext.getCmp('myGrid2').getSelection()[0];
		selectedRecord.set('ACCT_CD', record.get('ACCT_CD'));
		selectedRecord.set('ACCT_NM', record.get('ACCT_NM'));

		var popStore2 = this.getPopStore2Store();
		popStore2.removeAll();

		var popWin = tableview.up().up();
		popWin.destroy();
	},

});
