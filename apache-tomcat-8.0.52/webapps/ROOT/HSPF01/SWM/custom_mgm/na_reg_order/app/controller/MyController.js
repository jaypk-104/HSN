/*
 * File: app/controller/MyController.js
 *
 * This file was generated by Sencha Architect version 3.5.1.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('HsnaPoReqMgm.controller.MyController', {
    extend: 'Ext.app.Controller',

    views: [
        'MyViewport'
    ],
    stores: [
         'PoReqStore',
     ],
    control: {
        "#selectBtn": {
            click: 'SelectBtnClick'
        },
        "#orderBtn": {
        	click: 'orderBtnClick'
        },
        "#cancelBtn": {
        	click: 'cancelBtnClick'
        },
        "#loadBtn": {
        	click: 'loadBtnClick'
        },
        "#reRegBtn": {
        	click: 'reRegBtnClick'
        },
        "#removeBtn": {
        	click: 'removeBtnClick'
        },
        "#excelBtn": {
        	click: 'excelBtnClick'
        },
        
    },
    
    //조회버튼
    SelectBtnClick: function(button, e, eOpts) {
                var store=this.getPoReqStoreStore();
                store.load({
                	params: {
                		u_na_dt_to: Ext.getCmp('u_na_dt_to').getValue(), //HSNA발주일자
                		u_na_dt_from: Ext.getCmp('u_na_dt_from').getValue(), //HSNA발주일자
                		u_dt_to: Ext.getCmp('u_dt_to').getValue(), //납기요청일
                		u_dt_from: Ext.getCmp('u_dt_from').getValue(),  //납기요청일
                		u_po_no: Ext.getCmp('u_po_no').getValue(), // 발주번호
                		poradio: Ext.ComponentQuery.query('[name=poradio]')[0].getGroupValue(), //라디오버튼
                		V_chk_AA: Ext.getCmp('chk_AA').getValue(), 
                		V_chk_AU: Ext.getCmp('chk_AU').getValue(), 
                		V_chk_AM: Ext.getCmp('chk_AM').getValue(), 
                	},
                    callback: function (records, operation, success){
                   },
                   scope: this
                 });
    }, 
    
    //주문확정
    orderBtnClick: function(button, e, eOpts) {
    	var store=this.getPoReqStoreStore();
    	var gridObj = Ext.getCmp('grid1');
    	var gridRecord = gridObj.getSelectionModel().getSelection();
    	var flag = '';
    	var msg = '';
    	
    	for(var i = 0; i < gridRecord.length; i++){
    		var poNo = gridRecord[i].data['PO_NO'];
    		var poSeq = gridRecord[i].data['PO_SEQ'];
    		if(gridRecord[i].data['ITEM_CD'] == null || gridRecord[i].data['ITEM_CD'] == undefined ) {
    			flag = 'N';
    			msg = '본사 품목코드를 등록하세요.';
    			break;
    	    } 
    	    else if ((gridRecord[i].data['BP_ITEM_CD']==null) || (gridRecord[i].data['BP_ITEM_CD']==undefined)) {
    	    	flag = 'N';
    			msg = '해외법인 품목코드를 등록하세요.';
    	    	break;
    	    } 
    	    else if ((gridRecord[i].data['M_BP_CD']==null) || (gridRecord[i].data['M_BP_CD']==undefined)) {
    	    	flag = 'N';
    	    	msg = '품목코드에 대한 매입처를 등록하세요.<br>발주번호: '+gridRecord[i].data['PO_NO']+'<br>발주순번: '+gridRecord[i].data['PO_SEQ'];
    	    	break;
    	    } 
    	    else if ( gridRecord[i].data['PO_YN'] == 'Y'){
    	    	flag = 'N';
    	    	msg = '이미 발주생성 된 데이터입니다.';
    	    	break;
    	    }
    	    else {
    	    	flag = 'Y'
    	    }
    	}
    	if(flag == 'Y') {
    		store.sync({
        		params: {
        			V_TYPE: 'C',
        			V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
        		},
        		callback: function(){
        			store.reload();
        		}
        	});
    	} else {
    		Ext.Msg.alert('확인', msg);
    	}
		
    },
    
  //주문확정취소 버튼
    cancelBtnClick: function(button, e, eOpts) {
    	var store=this.getPoReqStoreStore();
    	var gridObj = Ext.getCmp('grid1');
    	var gridRecord = gridObj.getSelectionModel().getSelection();
    	
    	store.sync({
    		params: {
    			V_TYPE: 'D',
    			V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
    		},
    		callback: function(batch, options){
    			store.reload();
    		},
    	});
    },
    
    removeBtnClick: function(button, e, eOpts) {
    	var store=this.getPoReqStoreStore();
    	var gridObj = Ext.getCmp('grid1');
    	var gridRecord = gridObj.getSelectionModel().getSelection();
    	Ext.MessageBox.confirm('확인', '주문을 삭제하시겠습니까?', function(btn) {
    		if(btn == 'yes') {
    	    	
    	    	store.sync({
    	    		params: {
    	    			V_TYPE: 'R',
    	    			V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
    	    		},
    	    		callback: function(batch, options){
    	    			store.reload();
    	    		},
    	    	});
    		}
    	})
    	
    },
    
    //HSNA 발주데이터 불러오기
    loadBtnClick: function(button, e, eOpts) {
    	var store=this.getPoReqStoreStore();
    	Ext.Ajax.request({
    		  url:'sql/HsnCustomPoreqSql_LoadExec.jsp',
    		  method: 'post',
    		  params: {
          		V_TYPE: 'C', 
          		V_PO_NO: '', 
          		V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
          	},
          	success: function(resopnse) {
          		store.load({
          			params: {
                		u_na_dt_to: Ext.getCmp('u_na_dt_to').getValue(), //HSNA발주일자
                		u_na_dt_from: Ext.getCmp('u_na_dt_from').getValue(), //HSNA발주일자
                		u_dt_to: Ext.getCmp('u_dt_to').getValue(), //납기요청일
                		u_dt_from: Ext.getCmp('u_dt_from').getValue(),  //납기요청일
                		u_po_no: Ext.getCmp('u_po_no').getValue(), // 발주번호
                		poradio: Ext.ComponentQuery.query('[name=poradio]')[0].getGroupValue() //라디오버튼
                	},
                    callback: function (records, operation, success){
                    	Ext.Msg.alert('확인', '불러오기 완료');
                   },
                   scope: this
          		}); 	
    	}})
    },
    excelBtnClick: function(button, e, eOpts) {
        var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
    	var grid = Ext.getCmp('grid1');
    	grid.saveDocumentAs({
            type: 'xlsx',
            title: '해외법인 주문접수', //엑셀내타이틀
            fileName: currentDate+'.xlsx' //엑셀파일이름
		});
    },
});
