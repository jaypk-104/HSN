/*
 * File: app/controller/MyGridController1.js
 *
 * This file was generated by Sencha Architect version 4.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('SUPP_DLV_TOT_HSPF.controller.MyGridController1', {
	extend : 'Ext.app.Controller',

	stores : [ 'MyStore1', 'MyStore2', 'MyStore3' ],

	control : {
		"#gridAddBtn1" : {
			click : 'gridAddBtnClick1'
		},
		"#gridDelBtn1" : {
			click : 'gridDelBtnClick1'
		},
		"#xlsxDown1" : {
			click : 'xlsxDownClick1'
		},
		"#gridASNBtn" : {
			click : 'gridASNBtn'
		}
	},

	/* 납기현황등록 하단 그리드 */
	/* MyStore : [ USP_SUPP_DLV_TOT_HSPF_H ] */
	/* MyStore1 : [ USP_SUPP_DLV_TOT_HSPF_H ] */
	/* MyStore2 : [ USP_SUPP_DLV_TOT_HSPF_D ] */
	/* MyStore3 : [ USP_SUPP_DLV_TOT_HSPF_D ] */

	gridAddBtnClick1 : function(button, e, eOpts) {
	},

	// [-]버튼
	gridDelBtnClick1 : function(button, e, eOpts) {
		var store = Ext.getStore('MyStore1');
		var gridRecord = Ext.getCmp('myGrid1').getSelectionModel().getSelection();

		if (gridRecord.length > 0) {
			Ext.Msg.confirm('확인', '삭제하시겠습니까?', function(button) {
				if (button == 'yes') {
					for (var i = 0; i < gridRecord.length; i++) {
						if (gridRecord[i].data['V_TYPE'] == 'V') {
							gridRecord[i].data['V_TYPE'] = 'D';
						}
					}
					store.sync({
						params : {
							V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
							V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue()
						},
						callback : function(records, operation, success) {
							store.reload();
						}
					});
				}
			});
		}
	},

	// [ASN등록]버튼
	gridASNBtn : function(button, e, eOpts) {
		var gridRecord1 = Ext.getCmp('myGrid1').getSelectionModel().getSelection();
		if (gridRecord1.length == 0) {
			Ext.Msg.alert('확인', '항목을 선택하세요');
		} else {
			var popup = Ext.create("SUPP_DLV_TOT_HSPF.view.AsnPop");
			popup.show();
			
			popup.setSize(Ext.getBody().getViewSize());
			popup.setPagePosition(0, 0);
			
			if(parent.Ext.getCmp('GBP_CD').getValue() == '00000') {
				Ext.getCmp('canBacdBtn2').show(); //재발행허용
				Ext.getCmp('divBacdBtn2').show(); //바코드분할생성
				Ext.getCmp('G_GR_QTY').show();
				Ext.getCmp('G_DN_QTY').show();
				Ext.getCmp('gridAddBtn_W').show();
				Ext.getCmp('gridDelBtn_W').show();
				Ext.getCmp('bacdSaveBtn').show();
				Ext.getCmp('fileRegRequestBtn').show(); //첨부파일등록요청 메일 보내는 버튼
				
				if(parent.Ext.getCmp('GUSER_ID').getValue() == 'ADMIN' || parent.Ext.getCmp('GUSER_ID').getValue() == 'DARKJOB' ||
					parent.Ext.getCmp('GUSER_ID').getValue() == 'YOUNA1235' || parent.Ext.getCmp('GUSER_ID').getValue() == 'JAY') {
					Ext.getCmp('grdnBtn').show();
				}
			}
			
			
//		    Ext.fly(window).on('resize', function(e, w) {
//		    	popup.setSize(Ext.getBody().getViewSize());
//		    	popup.setPagePosition(0, 0);
//		    });
			

			var gridRecord1 = Ext.getCmp('myGrid1').getSelectionModel().getSelection();
			Ext.getCmp('W_ASN_NO').setValue(gridRecord1[0].data['ASN_NO']);
			Ext.getCmp('W_PO_NO').setValue(gridRecord1[0].data['PO_NO']);
			Ext.getCmp('W_PO_SEQ').setValue(gridRecord1[0].data['PO_SEQ']);
			Ext.getCmp('W_SYS_TYPE').setValue(gridRecord1[0].data['SYS_TYPE']);

			var store2 = this.getMyStore2Store();
			var store3 = this.getMyStore3Store();

			store2.load({
				params : {
					V_TYPE : 'HS',
					V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
					V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
					V_ASN_NO : gridRecord1[0].data['ASN_NO']
				},
				callback : function(records, operations, success) {
					store3.load({
						params : {
							V_TYPE : 'DS',
							V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
							V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
							V_ASN_NO : gridRecord1[0].data['ASN_NO']
						},
						callback : function(records, operations, success) {
							var fileStore = Ext.getStore('FileStore');
	                   		 fileStore.removeAll();
	                   	   	 fileStore.load({
	                   				params : {
	                   					V_TYPE : 'S',
	                   					V_COMP_ID: parent.Ext.getCmp('GCOMP_ID').getValue(),
	                   					V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue(),
	                   					V_ASN_NO: Ext.getCmp('W_ASN_NO').getValue(),
	                   				},
	                   				callback : function(records, operations, success) {
	                   					Ext.getCmp('fileAddBtn').setText('[ ' + records.length + ' ]');
	                   					
	                   					var filePreview = '';
	                   					for(var i=0; i<records.length; i++) {
	                   						filePreview += records[i].get('FILE_NM') + '<br>';
	                   					}
	                   					
	                   					var qText = '';
	                   					if(filePreview.length == 0) {
    				   						qText = '없음';
    				   					} else {
    				   						qText = filePreview;
    				   					}
	                   					
		                            	Ext.tip.QuickTipManager.register({
		                                     target: 'fileAddBtn', // Target button's ID
		                                     title : '<span style=\'color:#9CFFFA\'>첨부파일현황</span>',  // QuickTip Header
		                                     text  : qText, // Tip content,
		                                     dismissDelay: 10000 // Hide after 10 seconds hover
		                                });
		                            	
	                   				}
	                   			});
						}
					});
				}
			});
		}
	},

	// [엑셀다운]버튼
	xlsxDownClick1 : function(button, e, eOpts) {
		var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
		var grid = Ext.getCmp('myGrid1');
		grid.saveDocumentAs({
			type : 'xlsx',
			title : 'test', // 엑셀내타이틀
			fileName : currentDate + '.xlsx' // 엑셀파일이름
		});
	},

});
