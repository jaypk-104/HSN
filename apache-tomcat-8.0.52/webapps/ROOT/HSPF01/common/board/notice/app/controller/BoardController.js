/*
 * File: app/controller/BoardController.js
 *
 * This file was generated by Sencha Architect version 4.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('HSPF_BOARD.controller.BoardController', {
    extend: 'Ext.app.Controller',

    control: {
        "#returnBtn2": {
            click: 'returnBtn2Click'
        },
        "#modifyBtn": {
            click: 'modifyBtnClick'
        },
        "#deleteBtn": {
            click: 'deleteBtnClick'
        },
        "#boardFileGrid": {
            celldblclick: 'boardFileGridCellDblClick'
        },
        "#replyCfmBtn": {
            click: 'replyCfmBtnClick'
        },
        "#replyGrid": {
            cellclick: 'replyGridCellClick'
        }
    },

    returnBtn2Click: function(button, e, eOpts) {
        Ext.getCmp('list_container').show();
        Ext.getCmp('board_container').hide();
        Ext.getCmp('write_container').hide();

        Ext.getCmp('list_container').setWidth(Ext.getBody().getViewSize().width);
        Ext.getCmp('list_container').setHeight(Ext.getBody().getViewSize().height);

        var store = this.getStore('MainStore');
        store.reload();
    },

    modifyBtnClick: function(button, e, eOpts) {
        var idx_num = Ext.getCmp('V_IDX_NUM').getValue();
        var store = this.getStore('MainStore');
        var record = store.findRecord('IDX_NUM', idx_num);

        Ext.getCmp('V_WRITE_TITLE').setValue(Ext.getCmp('V_BOARD_TITLE').getValue());
        Ext.getCmp('V_WRITE_CONTENT').setValue(Ext.getCmp('V_BOARD_CONTENT').html);


        if(record.data['IMP_YN'] == 'Y'){
            Ext.getCmp('V_WRITE_IMP_YN').setValue(true);
        }
        else{
            Ext.getCmp('V_WRITE_IMP_YN').setValue(false);
        }

        if(record.data['SHOW_DT_TO'] == '2119-01-01'){
            Ext.getCmp('V_WRITE_SHOW_DT_FR').setValue();
            Ext.getCmp('V_WRITE_SHOW_DT_TO').setValue();
            Ext.getCmp('V_WRITE_SHOW_DT_ALL').setValue(true);
        }
        else{
            Ext.getCmp('V_WRITE_SHOW_DT_FR').setValue(record.data['SHOW_DT_FR']);
            Ext.getCmp('V_WRITE_SHOW_DT_TO').setValue(record.data['SHOW_DT_TO']);
        }


        Ext.getCmp('list_container').hide();
        Ext.getCmp('board_container').hide();
        Ext.getCmp('write_container').show();
    },

    deleteBtnClick: function(button, e, eOpts) {
        var store = this.getStore('MainStore');

        Ext.Msg.confirm('확인', '삭제 하시겠습니까?', function(btn) {
            if (btn == 'yes') {
                Ext.Ajax.request({
                    url:'sql/board_mgm.jsp',
                    method: 'post',
                    params: {
                        V_COMP_ID : 'HSN',
                        V_TYPE: 'D',
                        V_IDX_NUM : Ext.getCmp('V_IDX_NUM').getValue(),
                        V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
                    },

                    success : function(response) {
                        Ext.getCmp('list_container').show();
                        Ext.getCmp('board_container').hide();
                        Ext.getCmp('write_container').hide();

                        store.reload();
                    },
                    scope: this
                });
            }
        });
    },

    boardFileGridCellDblClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
        var V_FILE_NM = record.data['FILE_NM'];
        var V_FILE_NM_PC = record.data['FILE_NM_PC'];
        V_FILE_NM = encodeURI(V_FILE_NM);
        V_FILE_NM_PC = encodeURI(V_FILE_NM_PC);
        var myWin=new Ext.Window(
            {
                title : '파일다운로드',
                html : '<iframe name="xxx" border =0 src="sql/board_file.jsp?V_TYPE=DOWN&V_FILE_NM='+V_FILE_NM+'&V_FILE_NM_PC='+V_FILE_NM_PC+'" width="1%" height="1%"></iframe>',
                width :500,
                height:500
            });
        myWin.show();
        myWin.hide();
    },

    replyCfmBtnClick: function(button, e, eOpts) {
        var store = this.getStore('ReplyStore');
        var REPLY_TEXT = Ext.getCmp('V_REPLY_TEXT').getValue();
        Ext.Msg.confirm('확인', '댓글 등록 하시겠습니까?', function(btn) {
            if (btn == 'yes') {
                Ext.Ajax.request({
                    url:'sql/board_reply.jsp',
                    method: 'post',
                    params: {
                        V_COMP_ID : 'HSN',
                        V_TYPE: 'I',
                        V_IDX_NUM : Ext.getCmp('V_IDX_NUM').getValue(),
                        V_REPLY_TEXT : REPLY_TEXT,
                        V_HIDDEN_YN : Ext.getCmp('V_HIDDEN_YN').getValue(),
                        V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
                    },

                    success : function(response) {
                        store.reload();
                        Ext.getCmp('V_REPLY_TEXT').setValue();
                        Ext.getCmp('V_HIDDEN_YN').setValue(false);

                        Ext.Ajax.request({
                            url : '/HSPF01/common/MailingService_board.jsp',
                            method : 'post',
                            params : {
                                V_COMP_ID : 'HSN',
                                V_TYPE: 'EMAIL_YN',
                                V_IDX_NUM : Ext.getCmp('V_IDX_NUM').getValue(),
                                V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
                            },
                            success: function(response) {
                                var jsonResult = Ext.JSON.decode(response.responseText);
                                var length = jsonResult.resultList.length;
                                for(var i = 0; i < length; i++) {
                                    // 이메일 수신여부가 Y이면
                                    if(jsonResult.resultList[i].EMAIL_YN == 'Y') {
                                        var email = jsonResult.resultList[i].EMAIL;
                                        Ext.Ajax.request({
                                            url : '/HSPF01/common/MailingService_board.jsp',
                                            method : 'post',
                                            params : {
                                                V_COMP_ID : 'HSN',
                                                V_TYPE: 'EMAIL_SEND',
                                                V_TYPE2 : 'REPLY',
                                                V_EMAIL: email,
                                                V_TITLE : Ext.getCmp('V_BOARD_TITLE').getValue(),
                                                V_REPLY_TEXT : REPLY_TEXT,
                                            },
                                            success: function(response) {
                                            },
                                            scope : this
                                        });
                                    }
                                }
                            },
                            scope : this
                        });

                    },
                    scope: this
                });
            }
        });
    },

    replyGridCellClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
        var cellDataIndex = tableview.eventPosition.column.dataIndex;
        if(cellDataIndex == 'reply'){
            var window = Ext.create('HSPF_BOARD.view.ReplyWindow');
            Ext.getCmp('W_REF_IDX').setValue(record.data['REF_IDX']);
            Ext.getCmp('W_PARENT_REPLY_IDX').setValue(record.data['REPLY_IDX']);
            Ext.getCmp('W_REPLY_LEVEL').setValue(record.data['REPLY_LEVEL']);
            window.show();
        }

    }

});
