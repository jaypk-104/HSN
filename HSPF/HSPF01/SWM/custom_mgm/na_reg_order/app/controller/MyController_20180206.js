/*
 * File: app/controller/MyController.js
 *
 * This file was generated by Sencha Architect version 3.5.1.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('HsnaPoReqMgm.controller.MyController', {
    extend: 'Ext.app.Controller',

    views: [
        'MyViewport'
    ],
    stores: [
         'PoReqStore',
     ],
    control: {
        "#selectBtn": {
            click: 'SelectBtnClick'
        },
        "#orderBtn": {
        	click: 'orderBtnClick'
        },
        "#cancelBtn": {
        	click: 'cancelBtnClick'
        },
        "#loadBtn": {
        	click: 'loadBtnClick'
        },
        "#reRegBtn": {
        	click: 'reRegBtnClick'
        }
    },
    
    //조회버튼
    SelectBtnClick: function(button, e, eOpts) {
                var store=this.getPoReqStoreStore();
                store.load({
                	params: {
                		u_na_dt_to: Ext.getCmp('u_na_dt_to').getValue(), //HSNA발주일자
                		u_na_dt_from: Ext.getCmp('u_na_dt_from').getValue(), //HSNA발주일자
                		u_dt_to: Ext.getCmp('u_dt_to').getValue(), //납기요청일
                		u_dt_from: Ext.getCmp('u_dt_from').getValue(),  //납기요청일
                		u_po_no: Ext.getCmp('u_po_no').getValue(), // 발주번호
                		poradio: Ext.ComponentQuery.query('[name=poradio]')[0].getGroupValue() //라디오버튼
                	},
                    callback: function (records, operation, success){
                   },
                   scope: this
                 });
    }, 
    
    //주문확정
    orderBtnClick: function(button, e, eOpts) {
    	var store=this.getPoReqStoreStore();
    	var gridObj = Ext.getCmp('grid1');
    	var gridRecord = gridObj.getSelectionModel().getSelection();
    	for(var i = 0; i < gridRecord.length; i++){
    		var poNo = gridRecord[i].data['PO_NO'];
    		var poSeq = gridRecord[i].data['PO_SEQ'];
//    		alert('poNo:'+poNo+', poSeq:'+poSeq);
    		if(gridRecord[i].data['ITEM_CD']===null) {
    	    	alert('품목코드를 기준정보에 등록하세요\n'+poNo+', '+poSeq);
    	    	gridObj.getSelectionModel().deselect(gridRecord[i]);
    	    	break;
    	    } 
//    	    else if (gridRecord[i].data['SL_PLC']!==gridRecord[i].data['BASE_SL_PRC']) {
//    	    	alert('단가와 기준금액이 다릅니다.\n'+poNo+', '+poSeq);
//    	    	break;
//    	    }
    	    else if ((gridRecord[i].data['BP_ITEM_CD']!==null) && (gridRecord[i].data['ITEM_CD']===null)) {
    	    	alert('HSNA품목코드존재, 본사품목코드미존재 코드를 확인하세요(오류메시지정정필요)\n'+poNo+', '+poSeq);
    	    	gridObj.getSelectionModel().deselect(gridRecord[i]);
    	    	break;
    	    } 
    	    else if ( gridRecord[i].data['PO_YN'] == 'Y'){
    	    	alert('이미 발주 생성된 데이터입니다.\n'+poNo+', '+poSeq);
//    	    	gridRecord[i].deselect();
    	    	gridObj.getSelectionModel().deselect(gridRecord[i]);
    	    }
    	    else {
    	    	/*
    	    	Ext.Ajax.request({
  	      		  url:'/swm/custom/naporeqmgm/sql/HsnCustomPoreqSql_OrderExec.do',
  	      		  method: 'post',
  	      		  params: {
  	            		V_TYPE: 'C', 
  	            		V_PO_NO: poNo,
  	            		V_PO_SEQ: poSeq,
  	            		V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
  	            	},
  	            	callback: function(){
  	            		store.reload();
  	            	},
  	            	success: function(response) {
  	      	}})
  	      	*/
    	    }
    	}

		store.sync({
    		params: {
    			V_TYPE: 'C',
    			V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
    		},
    		callback: function(){
    			store.reload();
    		}
    	});
    	
    	
    	
    	/*
    	store.load({
    		params: {
    			u_na_dt_to: Ext.getCmp('u_na_dt_to').getValue(), //HSNA발주일자
    			u_na_dt_from: Ext.getCmp('u_na_dt_from').getValue(), //HSNA발주일자
    			u_dt_to: Ext.getCmp('u_dt_to').getValue(), //납기요청일
    			u_dt_from: Ext.getCmp('u_dt_from').getValue(),  //납기요청일
    			u_po_no: Ext.getCmp('u_po_no').getValue(), // 발주번호
//	                  		poradio: Ext.ComponentQuery.query('[name=poradio]')[0].getGroupValue() //라디오버튼
    			poradio: 'Y'
    		},
    		scope: this
    	}); 	
    	*/
    },
    
  //주문확정취소 버튼
    cancelBtnClick: function(button, e, eOpts) {
    	var store=this.getPoReqStoreStore();
    	var gridObj = Ext.getCmp('grid1');
    	var gridRecord = gridObj.getSelectionModel().getSelection();
    	
    	store.sync({
    		params: {
    			V_TYPE: 'D',
    			V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
    		},
    		callback: function(batch, options){

    			var response = batch.operations[0]._response.responseText;
    			if( response.indexOf('{') != -1){
    				var jResult = Ext.JSON.decode(response);
            		var jPO_NO = jResult.PO_NO;
            		var jPO_SEQ = jResult.PO_SEQ;
            		var jPO_CFM = jResult.PO_CFM;
            		if(jPO_CFM=='Y') {
            			alert('발주확정된 건은 취소할 수 없습니다. \n' + jPO_NO +'-'+jPO_SEQ);
            		}
    			}
    			
        		
    			//console.log(batch.operations[1]);
//    			console.log(store.getProxy().getReader());
//    			console.log(options);
//    	    	String jsonData = URLDecoder.decode(resultList, "UTF-8");
    	    	
//    			console.log("callback");
//    			console.log(batch);
//    			console.log(options);
//    			var jResult = Ext.JSON.decode(batch.responseText);
//    			console.log(jResult);
//    			
//        		var jPO_NO = jResult.PO_NO;
//        		var jPO_SEQ = jResult.PO_SEQ;
//        		var jPO_CFM = jResult.PO_CFM;
//        		console.log(jPO_CFM);
//        		if(jPO_CFM=='Y') {
//        			alert('발주확정된 건은 취소할 수 없습니다. \n' + jPO_NO +'-'+jPO_SEQ);
//        		}
    			store.reload();
    		},
    	});
    	
    	
    	/*
    	for(var i = 0; i < gridRecord.length; i++){
    		var poNo = gridRecord[i].data['PO_NO'];
    		var poSeq = gridRecord[i].data['PO_SEQ'];
//    		alert('poNo:'+poNo+', poSeq:'+poSeq);
	        	Ext.Ajax.request({
	      		  url:'/swm/custom/naporeqmgm/sql/HsnCustomPoreqSql_OrderExec.do',
	      		  method: 'post',
	      		  params: {
	            		V_TYPE: 'D', 
	            		V_PO_NO: poNo,
	            		V_PO_SEQ: poSeq,
	            		V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
	            	},
	            	callback: function(){
	            		store.reload();
	            	},
	            	success: function(response) {
	            		console.log(response);
	            		var jResult = Ext.JSON.decode(response.responseText);
	            		var jPO_NO = jResult.PO_NO;
	            		var jPO_SEQ = jResult.PO_SEQ;
	            		var jPO_CFM = jResult.PO_CFM;
		            		if(jPO_CFM=='Y') {
		            			alert('발주확정된 건은 취소할 수 없습니다. \n' + jPO_NO +'-'+jPO_SEQ);
		            		}
		            		if(gridRecord[i].length-1 == i) {
		            			store.load({
		            				params: {
		            					u_na_dt_to: Ext.getCmp('u_na_dt_to').getValue(), //HSNA발주일자
		            					u_na_dt_from: Ext.getCmp('u_na_dt_from').getValue(), //HSNA발주일자
		            					u_dt_to: Ext.getCmp('u_dt_to').getValue(), //납기요청일
		            					u_dt_from: Ext.getCmp('u_dt_from').getValue(),  //납기요청일
		            					u_po_no: Ext.getCmp('u_po_no').getValue(), // 발주번호
		            					poradio: Ext.ComponentQuery.query('[name=poradio]')[0].getGroupValue(), //라디오버튼
		            			//          		poradio: 'N'
		            			//    	Ext.getCmp('grid1').getView().refresh();
		            			    }
		            		})
		            		}
	            		}
	            	
	      	});
	      	
			
    	}
    	*/
    	
    	},
    
    //HSNA 발주데이터 불러오기
    loadBtnClick: function(button, e, eOpts) {
    	var store=this.getPoReqStoreStore();
    	Ext.Ajax.request({
    		  url:'/swm/custom/naporeqmgm/sql/HsnCustomPoreqSql_LoadExec.do',
    		  method: 'post',
    		  params: {
          		V_TYPE: 'C', 
          		V_PO_NO: '', 
          		V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue()
          	},
          	success: function(resopnse) {
          		store.load({
          			params: {
                		u_na_dt_to: Ext.getCmp('u_na_dt_to').getValue(), //HSNA발주일자
                		u_na_dt_from: Ext.getCmp('u_na_dt_from').getValue(), //HSNA발주일자
                		u_dt_to: Ext.getCmp('u_dt_to').getValue(), //납기요청일
                		u_dt_from: Ext.getCmp('u_dt_from').getValue(),  //납기요청일
                		u_po_no: Ext.getCmp('u_po_no').getValue(), // 발주번호
                		poradio: Ext.ComponentQuery.query('[name=poradio]')[0].getGroupValue() //라디오버튼
                	},
                    callback: function (records, operation, success){
                    	Ext.Msg.alert('확인', '불러오기 완료');
                   },
                   scope: this
          		}); 	
    	}})
    }
    	
});
