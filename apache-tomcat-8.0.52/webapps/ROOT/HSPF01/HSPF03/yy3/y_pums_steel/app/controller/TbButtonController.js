/*
 * File: app/controller/TbButtonController.js
 *
 * This file was generated by Sencha Architect version 4.2.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Y_PUMS_STEEL.controller.TbButtonController', {
    extend: 'Ext.app.Controller',

    stores: ['MyStore', 'MyStore1', 'MyStore2', 'MyStore3' ],
    control: {
        "#selBtn": {
            click: 'selBtnClick'
        },
        "#saveBtn": {
            click: 'saveBtnClick'
        },
        "#delBtn": {
        	click: 'delBtnClick'
        },
        "#clrBtn": {
            click: 'clrBtnClick'
        },
        "#clsBtn": {
            click: 'clsBtnClick'
        },
        "#copyBtn": {
        	click: 'copyBtnClick'
        },
        "myform textfield[name=search_field]": {
            specialkey: 'tfEnter'
        }
    },

    selBtnClick: function(button, e, eOpts) {
		var V_RISK_NO = Ext.getCmp('V_RISK_NO').getValue();
		
		if(V_RISK_NO != '') {
			/*1. 리스크헤더조회*/
			Ext.Ajax.request({
				url:'sql/Y_PUMS_STEEL.jsp',
				method: 'post',
				params: {
					V_TYPE: 'SH',  
					V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
					V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
					V_RISK_NO : Ext.getCmp('V_RISK_NO').getValue(),
				},
				callback : function(records,operations,success){
				},
				success : function(response) {
					var res = response.responseText;
					if(res.match('Exception')) {
						Ext.Msg.alert('확인', res);
					} else {
						res = Ext.JSON.decode(response.responseText).resultList[0];
						
						Ext.getCmp('V_RISK_DOC_NO').setValue(res.RISK_DOC_NO);
						Ext.getCmp('V_DEPT_CD').setValue(res.DEPT_CD);
						Ext.getCmp('V_S_BP_CD').setValue(res.S_BP_CD);
						Ext.getCmp('V_S_BP_NM').setValue(res.S_BP_NM);
						Ext.getCmp('V_RISK_NM').setValue(res.RISK_NM);
						Ext.getCmp('V_SALE_TYPE').setValue(res.SALE_TYPE);
						Ext.getCmp('V_IV_TYPE').setValue(res.IV_TYPE);

						Ext.getCmp('V_CUR').setValue(res.CUR);
						
						Ext.getCmp('V_MON_APR_AMT').setValue(Ext.util.Format.number(res.MON_APR_AMT, '0,000.00'));
						Ext.getCmp('V_SUM_APR_AMT').setValue(Ext.util.Format.number(res.SUM_APR_AMT, '0,000.00'));
						Ext.getCmp('V_BILL_LT_APR_AMT').setValue(Ext.util.Format.number(res.BILL_LT_APR_AMT, '0,000.00'));

						Ext.getCmp('V_MON_USE_AMT').setValue(res.MON_USE_AMT);
						Ext.getCmp('V_SUM_USE_AMT').setValue(res.SUM_USE_AMT);
						Ext.getCmp('V_BILL_LT_USE_AMT').setValue(res.BILL_LT_USE_AMT);
						
						Ext.getCmp('V_PAY_METH').setValue(res.PAY_METH);
						Ext.getCmp('V_PAY_METH_SL').setValue(res.PAY_METH_SL);
						
						Ext.getCmp('V_BILL_LT_AMT').setValue(Ext.util.Format.number(res.BILL_LT_AMT, '0,000.00'));
						Ext.getCmp('V_BN_DT').setValue(res.BN_DT);
						
						Ext.getCmp('V_MID_TYPE').setValue(res.MID_TYPE);
						Ext.getCmp('V_MID_RATE').setValue(Ext.util.Format.number(res.MID_RATE, '0,000.00'));
						Ext.getCmp('V_MID_UNIT').setValue(res.MID_UNIT);
						
						Ext.getCmp('V_HEDGE_AMT').setValue(Ext.util.Format.number(res.HEDGE_AMT, '0,000.00'));
						Ext.getCmp('V_HEDGE_TYPE').setValue(res.HEDGE_TYPE);
						Ext.getCmp('V_REMARK').setValue(res.REMARK);
						
						Ext.getCmp('V_RISK_TYPE').setValue(res.RISK_TYPE);
						Ext.getCmp('V_RISK_YN').setValue(res.RISK_YN);
						
//						console.log(res.RISK_TYPE);
						
						/*계약금조회*/
						var store1 = Ext.getStore('MyStore1');
						store1.removeAll();
						store1.load({
							params: {
								V_TYPE: 'S',
								V_TYPE2: 'CR',
								V_COMP_ID: parent.Ext.getCmp('GCOMP_ID').getValue(),
								V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue(),
								V_RISK_NO: Ext.getCmp('V_RISK_NO').getValue(),
							},
							callback: function(records,operations,success){
							}
						});
						
						/*외상조회*/
						var store2 = Ext.getStore('MyStore2');
						store2.removeAll();
						store2.load({
							params: {
								V_TYPE: 'S',
								V_TYPE2: 'BN',
								V_COMP_ID: parent.Ext.getCmp('GCOMP_ID').getValue(),
								V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue(),
								V_RISK_NO: Ext.getCmp('V_RISK_NO').getValue(),
							},
							callback: function(records,operations,success){
							}
						});

						/*이자조회*/
						var store3 = Ext.getStore('MyStore3');
						store3.removeAll();
						store3.load({
							params: {
								V_TYPE: 'S',
								V_TYPE2: 'RT',
								V_COMP_ID: parent.Ext.getCmp('GCOMP_ID').getValue(),
								V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue(),
								V_RISK_NO: Ext.getCmp('V_RISK_NO').getValue(),
							},
							callback: function(records,operations,success){
							}
						});
						
						
						
						//삭제가능여부확인
						Ext.Ajax.request({
							url:'sql/Y_PUMS_STEEL.jsp',
							method: 'post',
							params: {
								V_TYPE: 'STATUS',  
								V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
								V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
								V_RISK_NO : Ext.getCmp('V_RISK_NO').getValue(),
							},
							callback : function(records,operations,success){
							},
							success : function(response) {
								var res = response.responseText;
								
								if(res == 'UNABLE') {
									Ext.getCmp('saveBtn').setDisabled(true);
									Ext.getCmp('delBtn').setDisabled(true);
									Ext.getCmp('copyBtn').setDisabled(true);
									
									Ext.getCmp('gridAddBtn1').setDisabled(true);
									Ext.getCmp('gridDelBtn1').setDisabled(true);
									Ext.getCmp('gridSaveBtn1').setDisabled(true);
									
									Ext.getCmp('gridAddBtn2').setDisabled(true);
									Ext.getCmp('gridDelBtn2').setDisabled(true);
									Ext.getCmp('gridSaveBtn2').setDisabled(true);

									Ext.getCmp('gridAddBtn3').setDisabled(true);
									Ext.getCmp('gridDelBtn3').setDisabled(true);
									Ext.getCmp('gridSaveBtn3').setDisabled(true);
									
								} else {
									Ext.getCmp('saveBtn').setDisabled(false);
									Ext.getCmp('delBtn').setDisabled(false);
									Ext.getCmp('copyBtn').setDisabled(false);
									
									Ext.getCmp('gridAddBtn1').setDisabled(false);
									Ext.getCmp('gridDelBtn1').setDisabled(false);
									Ext.getCmp('gridSaveBtn1').setDisabled(false);
									
									Ext.getCmp('gridAddBtn2').setDisabled(false);
									Ext.getCmp('gridDelBtn2').setDisabled(false);
									Ext.getCmp('gridSaveBtn2').setDisabled(false);

									Ext.getCmp('gridAddBtn3').setDisabled(false);
									Ext.getCmp('gridDelBtn3').setDisabled(false);
									Ext.getCmp('gridSaveBtn3').setDisabled(false);
									
								}
							}
						});
					}
				},
				scope: this
			});
		} else {
			Ext.Msg.alert('확인', '리스크관리번호를 입력하세요.');
		}
    	
    },

    saveBtnClick: function(button, e, eOpts) {
    	var flag = '';
    	var msg = '';
    	
    	if(Ext.getCmp('V_RISK_DOC_NO').getValue() == '') {
    		flag = 'F';
    		msg = '리스크문서번호를 입력하세요.';
    	}
    	else if (Ext.getCmp('V_S_BP_CD').getValue() == '') {
    		flag = 'F';
    		msg = '판매처를 입력하세요.';
    	}
    	else if (Ext.getCmp('V_DEPT_CD').getValue() == '') {
    		flag = 'F';
    		msg = '부서코드를 입력하세요.';
    	}
    	else if (Ext.getCmp('V_DEPT_CD').getValue() == '') {
    		flag = 'F';
    		msg = '부서코드를 입력하세요.';
    	}
    	else if (Ext.getCmp('V_SUM_APR_AMT').getValue() == '') {
    		flag = 'F';
    		msg = '누계한도를 입력하세요.';
    	} else {
    		flag = 'T';
    	}
    	
    	if(flag == 'T') {
    		Ext.Ajax.request({
        		url:'sql/Y_PUMS_STEEL.jsp',
        		method: 'post',
        		params: {
        			V_TYPE: 'HI',  
        			V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
        			V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
        			V_RISK_NO : Ext.getCmp('V_RISK_NO').getValue(),
        			V_RISK_DOC_NO : Ext.getCmp('V_RISK_DOC_NO').getValue(),
        			V_S_BP_CD : Ext.getCmp('V_S_BP_CD').getValue(),
        			V_DEPT_CD : Ext.getCmp('V_DEPT_CD').getValue(),
        			V_RISK_DT : Ext.getCmp('V_RISK_DT').getValue(),
        			V_RISK_NM : Ext.getCmp('V_RISK_NM').getValue(),
        			V_SALE_TYPE : Ext.getCmp('V_SALE_TYPE').getValue(),
        			V_IV_TYPE : Ext.getCmp('V_IV_TYPE').getValue(),
        			
        			V_RISK_TYPE : Ext.getCmp('V_RISK_TYPE').getValue(),
        			V_RISK_YN : Ext.getCmp('V_RISK_YN').getValue(),

        			V_MON_APR_AMT : Ext.getCmp('V_MON_APR_AMT').getValue(),
        			V_MON_USE_AMT : Ext.getCmp('V_MON_USE_AMT').getValue(),
        			V_SUM_APR_AMT : Ext.getCmp('V_SUM_APR_AMT').getValue(),
        			V_SUM_USE_AMT : Ext.getCmp('V_SUM_USE_AMT').getValue(),
        			V_BILL_LT_APR_AMT : Ext.getCmp('V_BILL_LT_APR_AMT').getValue(),
        			V_BILL_LT_USE_AMT : Ext.getCmp('V_BILL_LT_USE_AMT').getValue(),
        			V_PAY_METH : Ext.getCmp('V_PAY_METH').getValue(),
        			V_BILL_LT_AMT : Ext.getCmp('V_BILL_LT_AMT').getValue(),
        			
        			V_MID_TYPE : Ext.getCmp('V_MID_TYPE').getValue(),
        			V_MID_RATE : Ext.getCmp('V_MID_RATE').getValue(),
        			V_MID_UNIT : Ext.getCmp('V_MID_UNIT').getValue(),
        			
        			V_HEDGE_AMT : Ext.getCmp('V_HEDGE_AMT').getValue(),
        			V_HEDGE_TYPE : Ext.getCmp('V_HEDGE_TYPE').getValue(),
        			V_REMARK : Ext.getCmp('V_REMARK').getValue(),
        			
        			V_CUR : Ext.getCmp('V_CUR').getValue(),
        			V_PAY_METH_SL : Ext.getCmp('V_PAY_METH_SL').getValue(),
        			V_BN_DT : Ext.getCmp('V_BN_DT').getValue(),
        			
        		},
        		callback : function(records,operations,success){
    			},
        	    success : function(response) {
        	    	var res = response.responseText;
        	    	if(res.match('Exception')) {
    					Ext.Msg.alert('확인', res);
    				} else if (res.match('RK')){
    					Ext.getCmp('V_RISK_NO').setValue(res);
    					
    					var tbController = Y_PUMS_STEEL.app.getController("TbButtonController");
    		    		tbController.selBtnClick();
    		    		
    		    		Ext.toast({
							title : ' ',
							timeout : 1000,
							html : '저장완료',
							style : 'text-align: center',
							align : 't',
							width : 130,
						});
    				} else if (res == 'success'){
    					var tbController = Y_PUMS_STEEL.app.getController("TbButtonController");
    		    		tbController.selBtnClick();
    		    		
    		    		Ext.toast({
							title : ' ',
							timeout : 1000,
							html : '저장완료',
							style : 'text-align: center',
							align : 't',
							width : 130,
    		    		})
    				}
        	    },
        		scope: this
        	});
    	} else {
    		Ext.Msg.alert('확인', msg);
    	}
    	
    },
    delBtnClick: function(button, e, eOpts) {
    	var flag = '';
    	var msg = '';
    	
    	if(Ext.getCmp('V_RISK_NO').getValue() == '') {
    		flag = 'F';
    		msg = '리스크번호를 입력하세요.';
    	} else {
    		flag = 'T';
    	}
    	
    	if(flag == 'T') {
    		Ext.Msg.confirm('확인','삭제하시겠습니까?', function(button){
    			if(button == 'yes') {
		    		Ext.Ajax.request({
		    			url:'sql/Y_PUMS_STEEL.jsp',
		    			method: 'post',
		    			params: {
		    				V_TYPE: 'D',  
		    				V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
		    				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
		    				V_RISK_NO : Ext.getCmp('V_RISK_NO').getValue(),
		    				
		    			},
		    			callback : function(records,operations,success){
		    			},
		    			success : function(response) {
		    				var res = response.responseText;
		    				if(res.match('Exception')) {
		    					Ext.Msg.alert('확인', res);
		    				} else {
		    					var tbController = Y_PUMS_STEEL.app.getController("TbButtonController");
		    		    		tbController.clrBtnClick();
		    					
		    					Ext.toast({
		        					title : ' ',
		        					timeout : 1000,
		        					html : '삭제완료',
		        					style : 'text-align: center',
		        					align : 't',
		        					width : 130,
		        				});
		    				}
		    			},
		    			scope: this
		    		});
    			}});
    	} else {
    		Ext.Msg.alert('확인', msg);
    	}
    	
    },

    clrBtnClick: function(button, e, eOpts) {
    	var store = this.getMyStoreStore();
    	var store1 = this.getMyStore1Store();
    	var store2 = this.getMyStore2Store();
    	var store3 = this.getMyStore3Store();
    	
    	store.removeAll();
    	store1.removeAll();
    	store2.removeAll();
    	store3.removeAll();

    	Ext.getCmp('V_RISK_NO').setValue('');
    	Ext.getCmp('V_RISK_DOC_NO').setValue('');
		Ext.getCmp('V_DEPT_CD').setValue('5128');
		Ext.getCmp('V_S_BP_CD').setValue('');
		Ext.getCmp('V_S_BP_NM').setValue('');
		Ext.getCmp('V_RISK_NM').setValue('');
		Ext.getCmp('V_RISK_DT').setValue(new Date());	
		Ext.getCmp('V_SALE_TYPE').setValue(null);
		Ext.getCmp('V_IV_TYPE').setValue(null);
		Ext.getCmp('V_MON_APR_AMT').setValue(0);
		Ext.getCmp('V_SUM_APR_AMT').setValue(0);
		Ext.getCmp('V_BILL_LT_APR_AMT').setValue(0);
		Ext.getCmp('V_MON_USE_AMT').setValue(0);
		Ext.getCmp('V_SUM_USE_AMT').setValue(0);
		Ext.getCmp('V_BILL_LT_USE_AMT').setValue(0);
		Ext.getCmp('V_PAY_METH').setValue(null);
		Ext.getCmp('V_BILL_LT_AMT').setValue(0);
		Ext.getCmp('V_MID_TYPE').setValue(null);
		Ext.getCmp('V_MID_RATE').setValue(0);
		Ext.getCmp('V_MID_UNIT').setValue('');
		Ext.getCmp('V_HEDGE_AMT').setValue(0);
		Ext.getCmp('V_HEDGE_TYPE').setValue('');
		Ext.getCmp('V_REMARK').setValue('');
		Ext.getCmp('V_RISK_TYPE').setValue('');
		
		Ext.getCmp('V_CUR').setValue('KRW');
		Ext.getCmp('V_PAY_METH_SL').setValue(null);
		Ext.getCmp('V_BN_DT').setValue('일 ~ 일');
		
		Ext.getCmp('saveBtn').setDisabled(false);
		Ext.getCmp('delBtn').setDisabled(false);
		Ext.getCmp('copyBtn').setDisabled(false);
		
		
		Ext.getCmp('gridAddBtn1').setDisabled(false);
		Ext.getCmp('gridDelBtn1').setDisabled(false);
		Ext.getCmp('gridSaveBtn1').setDisabled(false);
		
		Ext.getCmp('gridAddBtn2').setDisabled(false);
		Ext.getCmp('gridDelBtn2').setDisabled(false);
		Ext.getCmp('gridSaveBtn2').setDisabled(false);

		Ext.getCmp('gridAddBtn3').setDisabled(false);
		Ext.getCmp('gridDelBtn3').setDisabled(false);
		Ext.getCmp('gridSaveBtn3').setDisabled(false);
		
    },

    clsBtnClick: function(button, e, eOpts) {
		var tab = parent.Ext.getCmp('myTab');
		var activeTab = tab.getActiveTab();
		var tabIndex = tab.items.indexOf(activeTab);
		tab.remove(tabIndex, true);
	},
	
	copyBtnClick: function() {
		if(Ext.getCmp('V_RISK_NO').getValue() != '') {
			Ext.Msg.confirm('확인', '리스크문서를 복사하시겠습니까?',function(btn) {
				if(btn == 'yes') {
					Ext.Ajax.request({
						url:'sql/Y_PUMS_STEEL.jsp',
						method: 'post',
						params: {
							V_TYPE: 'CP',  
							V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
							V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
							V_RISK_NO : Ext.getCmp('V_RISK_NO').getValue(),
						},
						callback : function(records,operations,success){
						},
						success : function(response) {
							var res = response.responseText;
		    				if(res.match('Exception')) {
		    					Ext.Msg.alert('확인', res);
		    				} else {
		    					
		    					Ext.getCmp('V_RISK_NO').setValue(res);
		    					
		    					var tbController = Y_PUMS_STEEL.app.getController("TbButtonController");
		    		    		tbController.selBtnClick();
		    					
		    					Ext.toast({
		        					title : ' ',
		        					timeout : 1000,
		        					html : '복사완료',
		        					style : 'text-align: center',
		        					align : 't',
		        					width : 130,
		        				});
		    				}
						}
					});
				}
			});
		} else {
			Ext.Msg.alert('확인', '리스크문서를 선택하세요.');
		}
		
	},

    tfEnter: function(field, e, eOpts) {
        	if (e.getKey() == e.ENTER) {
        		this.selBtnClick();
        	}
    },
    
    
});
