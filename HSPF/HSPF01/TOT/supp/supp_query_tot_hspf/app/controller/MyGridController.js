/*
 * File: app/controller/MyGridController.js
 *
 * This file was generated by Sencha Architect version 4.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('SUPP_QUERY_TOT_HSPF.controller.MyGridController', {
    extend: 'Ext.app.Controller',

    stores: [
        'MyStore'
    ],

    control: {
        "#gridAddBtn": {
            click: 'gridAddBtnClick'
        },
        "#gridDelBtn": {
            click: 'gridDelBtnClick'
        },
        "#xlsxDown": {
            click: 'xlsxDownClick'
        },
        "#xmlDown": {
            click: 'xmlDownClick'
        },
        "#taxBtn": {
        	click: 'taxBtnClick'
        },
        "#myGrid": {
            celldblclick: 'onGridpanelCellDblClick'
        },
        '#fileGrid' : { /*파일다운더블클릭*/
			celldblclick : 'fileGridDblClick',
		},
		"#fileDelBtn" : { /*파일삭제*/
        	click : 'fileDelBtnClick'
        },
    },

    gridAddBtnClick: function(button, e, eOpts) {
        //var popup = Ext.create("B_COMP_HSPF.view.WinAddRow");
        //popup.show();
        //Ext.getCmp('rowCount').setValue(1);
    },

    gridDelBtnClick: function(button, e, eOpts) {
        var store = Ext.getStore('MyStore');
            	var gridRecord = Ext.getCmp('myGrid').getSelectionModel().getSelection();

            	if(gridRecord.length > 0) {
            		Ext.Msg.confirm('확인','삭제하시겠습니까?', function(button){
            			if(button == 'yes') {
            				for(var i=0; i<gridRecord.length; i++) {
            		    		if(gridRecord[i].data['V_TYPE']=='V') {
            		    			gridRecord[i].data['V_TYPE'] = 'D';
            		    		}
            		    	}
            		    	store.sync({
            					params: {
            						V_USR_ID : 'admin',//parent.Ext.getCmp('GUSER_ID').getValue(),
            					},
            		    		callback: function(records, operation, success) {
            		    			store.reload();
            					}
            		    	});
            			}
            		});
            	}
    },

    xlsxDownClick: function(button, e, eOpts) {
        var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
            	var grid = Ext.getCmp('myGrid');
            	grid.saveDocumentAs({
                    type: 'xlsx',
                    title: '납기현황조회', //엑셀내타이틀
                    fileName: currentDate+'.xlsx' //엑셀파일이름
        		});
    },

    xmlDownClick: function(button, e, eOpts) {
        var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
            	var grid = Ext.getCmp('myGrid');
            	grid.saveDocumentAs({
                    type: 'xml',
                    title: '납기현황조회', //엑셀내타이틀
                    fileName: currentDate+'.xml' //엑셀파일이름
        		});
    },
    taxBtnClick: function(){
    	alert("거래명세서 버튼 클릭");
    },
    
    onGridpanelCellDblClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
    	var cellDataIndex = tableview.eventPosition.column.dataIndex; //더블클릭한 셀 dataIndex 얻는것
    	
    	if(cellDataIndex == 'FILE_CONFIRM' && record.data['ASN_NO'].length > 5){
    		var window = Ext.create('SUPP_QUERY_TOT_HSPF.view.MyWindow');
    		window.show();
    		Ext.getCmp('W_ASN_NO').setValue(record.data['ASN_NO']);
    		
    		if(parent.Ext.getCmp('GBP_CD').getValue() == '00000'){
    			Ext.getCmp('fileDelBtn').show();
    		}
    		
    		var fileStore = Ext.getStore('FileStore');
    		fileStore.load({
    			params:{
    				V_TYPE: 'S',
    				V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
    				V_ASN_NO : record.data['ASN_NO']
    			}
    		});
    	}
    },
    fileGridDblClick:  function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
		var gridObj = Ext.getCmp('fileGrid');
		var gridRecord = gridObj.getSelectionModel().getSelection();
		var V_FILE_NM = gridRecord[0].data['FILE_NM'];
		var V_FILE_IN_SYSTEM_NM = gridRecord[0].data['FILE_IN_SYSTEM_NM'];
		V_FILE_NM = encodeURI(V_FILE_NM);
		V_FILE_IN_SYSTEM_NM = encodeURI(V_FILE_IN_SYSTEM_NM);
		var myWin=new Ext.Window(
				{
					title : '파일다운로드',
					html : '<iframe name="xxx" border =0 src="sql/SUPP_QUERY_TOT_HSPF_FILE.jsp?V_TYPE=D&V_FILE_NM='+V_FILE_NM+'&V_FILE_IN_SYSTEM_NM='+V_FILE_IN_SYSTEM_NM+'" width="1%" height="1%"></iframe>',
					width :500,
					height:500
				});
		myWin.show();
		myWin.hide();
	},
	/* [파일삭제] */
	fileDelBtnClick: function() {
    	var fileStore = Ext.getStore('FileStore');
    	var gridRecord = Ext.getCmp('fileGrid').getSelectionModel().getSelection();
    	
    	if(gridRecord.length > 0) {
    		Ext.MessageBox.confirm('확인', '삭제하시겠습니까?', function(btn) {
    			if(btn == 'yes') {
    				fileStore.sync({
    					params: {
    						V_TYPE: 'SYNC',
    						V_COMP_ID: parent.Ext.getCmp('GCOMP_ID').getValue(),
    						V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue(),
    					},
    					callback: function(records,operations,success){
    						
    						fileStore.load({
    							params : {
    								V_TYPE : 'S',
    								V_COMP_ID: parent.Ext.getCmp('GCOMP_ID').getValue(),
    								V_USR_ID: parent.Ext.getCmp('GUSER_ID').getValue(),
    								V_ASN_NO: Ext.getCmp('W_ASN_NO').getValue(),
    							},
//    							callback : function(records, operations, success) {
//    								var filePreview = '';
//    			   					for(var i=0; i<records.length; i++) {
//    			   						filePreview += records[i].get('FILE_NM') + '<br>';
//    			   					}
//    			   					
//    			   					var qText = '';
//    			   					if(filePreview.length == 0) {
//    			   						qText = '없음';
//    			   					} else {
//    			   						qText = filePreview;
//    			   					}
//    			   					
//				                	Ext.tip.QuickTipManager.register({
//				                          target: 'fileAddBtn', // Target button's ID
//				                          title : '<span style=\'color:#9CFFFA\'>첨부파일현황</span>',  // QuickTip Header
//				                          text  : qText,
//				                          dismissDelay: 10000 // Hide after 10 seconds hover
//				                    });
//				                	
//				                	Ext.getCmp('fileAddBtn').setText('[ ' + records.length + ' ]');
//    							}
    						});
    						
							
						}
    				});
    			}
    		})
    	}
    	
    },

});
