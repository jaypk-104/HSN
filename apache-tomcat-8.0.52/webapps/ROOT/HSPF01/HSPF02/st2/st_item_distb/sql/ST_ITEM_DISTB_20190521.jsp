<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@page import="org.json.simple.JSONArray"%>
<%@page import="org.json.simple.JSONValue"%>
<%@page import="net.sf.json.JSONObject"%>
<%@page import="java.io.PrintWriter"%>
<%@page import="java.io.StringWriter"%>
<%@page import="java.net.URLDecoder"%>
<%@page import="java.util.HashMap"%>
<%@page import="org.apache.commons.lang.StringUtils"%>
<%@ include file="/HSPF01/common/DB_Connection.jsp"%>

<%@page import="java.text.SimpleDateFormat"%>
<%@page import="java.util.Date"%>
<%@ page import="java.util.Properties"%>
<%@ page import="javax.mail.Message"%>
<%@ page import="javax.mail.Session"%>
<%@ page import="javax.mail.Transport"%>
<%@ page import="javax.mail.internet.InternetAddress"%>
<%@ page import="javax.mail.internet.MimeMessage"%>
<%@ page import="javax.mail.internet.MimeBodyPart"%>
<%@ page import="javax.mail.internet.MimeMultipart"%>
<%@ page import="javax.mail.BodyPart"%>
<%@ page import="javax.mail.Multipart"%>
<%@ page import="java.text.SimpleDateFormat"%>


<%
	request.setCharacterEncoding("utf-8");
	ResultSet rs = null;
	CallableStatement cs = null;
	CallableStatement cs2 = null;
	JSONObject jsonObject = new JSONObject();
	JSONArray jsonArray = new JSONArray();
	JSONObject subObject = null;

	try {
		String V_TYPE = request.getParameter("V_TYPE") == null ? "" : request.getParameter("V_TYPE");
		String V_COMP_ID = request.getParameter("V_COMP_ID") == null ? "" : request.getParameter("V_COMP_ID").toUpperCase();
		String V_USR_ID = request.getParameter("V_USR_ID") == null ? "" : request.getParameter("V_USR_ID").toUpperCase();
		String V_DATE = request.getParameter("V_DATE") == null ? "" : request.getParameter("V_DATE").toUpperCase().substring(0, 10);
		String V_S_BP_NM = request.getParameter("V_S_BP_NM") == null ? "" : request.getParameter("V_S_BP_NM").toUpperCase();
		String V_ITEM_CD = request.getParameter("V_ITEM_CD") == null ? "" : request.getParameter("V_ITEM_CD").toUpperCase();
		String V_SALE_TYPE = request.getParameter("V_SALE_TYPE") == null ? "" : request.getParameter("V_SALE_TYPE").toUpperCase();
		String V_IV_TYPE = request.getParameter("V_IV_TYPE") == null ? "" : request.getParameter("V_IV_TYPE").toUpperCase();
		String V_REGION = request.getParameter("V_REGION") == null ? "" : request.getParameter("V_REGION").toUpperCase();
		String V_LC_DOC_NO = request.getParameter("V_LC_DOC_NO") == null ? "" : request.getParameter("V_LC_DOC_NO").toUpperCase();
		String V_BL_DOC_NO = request.getParameter("V_BL_DOC_NO") == null ? "" : request.getParameter("V_BL_DOC_NO").toUpperCase();

		if (V_SALE_TYPE.equals("T")) {
			V_SALE_TYPE = "";
		}
		if (V_IV_TYPE.equals("T")) {
			V_IV_TYPE = "";
		}
		if (V_REGION.equals("T")) {
			V_REGION = "";
		}

		//상단
		if (V_TYPE.equals("S")) {
			// 			System.out.println(V_ITEM_CD);

			// // 			cs = conn.prepareCall("call DISTR_STOCK.USP_I_STOCK_BY_ITEM(?,?,?,?)");
			// 			cs = conn.prepareCall("call USP_I_STOCK_BY_ITEM(?,?,?,?)");
			// 			cs.setString(1, '"+V_DATE+"');//V_COMP_ID
			// 			cs.setString(2, V_ITEM_CD);//V_DN_DT
			// 			cs.setString(3, V_S_BP_NM);//V_S_BP_NM
			// 			cs.registerOutParameter(4, com.tmax.tibero.TbTypes.CURSOR);
			// 			cs.executeQuery();

			// 			rs = (ResultSet) cs.getObject(4);

			
			/*190517.JAY 미통관/미입고 상태의 미착을 추가하며 F.BOX_QTY -> NVL(F.BOX_QTY, E.BOX_QTY) 로 변경*/
			String sql = "";
			sql += "SELECT A.APPROV_MGM_NO, A.APPROV_NO, A.APPROV_NM, A.S_BP_CD, QQ.BP_NM, B.ITEM_CD,                                                                                                                                                                                                                                                                ";
			sql += "       OO.ITEM_NM, NN.LC_DOC_NO, J.BL_DOC_NO, LL.IN_DT, F.MVMT_DT,  NVL(F.BOX_QTY,E.BOX_QTY)-NVL(H.DN_BOX_QTY, 0) BOX_QTY,                                                                                                                                                                                                                                       ";
			sql += "      NVL(F.BOX_WGT_UNIT,E.BOX_WGT_UNIT) BOX_WGT_UNIT, NVL(F.QTY,E.QTY)                                                  -NVL(H.DN_QTY, 0) AS QTY, TO_DATE('" + V_DATE + "')-LL.IN_DT S_DAY,                                                                                                                                                                                                      ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT>=TO_DATE('" + V_DATE + "')-LL.IN_DT                                                                                                                                                                                                                                                                                          ";
			sql += "              THEN NVL(ROUND((F.QTY           -NVL(H.DN_QTY, 0))*(F.FORWARD_XCH_AMT+NVL(F.DISTR_AMT, 0))/F.QTY, 0), 0)                                                                                                                                                                                                                           ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END N_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "') -LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "')-LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              THEN ROUND((F.QTY                 -NVL(H.DN_QTY, 0))*(F.FORWARD_XCH_AMT+NVL(F.DISTR_AMT, 0))/F.QTY, 0)                                                                                                                                                                                                                             ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END O_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "') -LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              AND    O_RT< TO_DATE('" + V_DATE + "')-LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              THEN ROUND((F.QTY                 -NVL(H.DN_QTY, 0))*(F.FORWARD_XCH_AMT+NVL(F.DISTR_AMT, 0))/F.QTY, 0)                                                                                                                                                                                                                             ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END L_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       /*,ROUND((F.QTY-NVL(H.DN_QTY,0))*(F.FORWARD_XCH_AMT+NVL(F.DISTR_AMT,0))/F.QTY ,0) */                                                                                                                                                                                                                                                      ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT>=TO_DATE('" + V_DATE + "')-LL.IN_DT                                                                                                                                                                                                                                                                                          ";
			sql += "              THEN NVL(ROUND((F.QTY           -NVL(H.DN_QTY, 0))*(F.FORWARD_XCH_AMT+NVL(F.DISTR_AMT, 0))/F.QTY, 0), 0)                                                                                                                                                                                                                           ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "') -LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "')-LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              THEN ROUND((F.QTY                 -NVL(H.DN_QTY, 0))*(F.FORWARD_XCH_AMT+NVL(F.DISTR_AMT, 0))/F.QTY, 0)                                                                                                                                                                                                                             ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "') -LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              AND    O_RT< TO_DATE('" + V_DATE + "')-LL.IN_DT                                                                                                                                                                                                                                                                                        ";
			sql += "              THEN ROUND((F.QTY                 -NVL(H.DN_QTY, 0))*(F.FORWARD_XCH_AMT+NVL(F.DISTR_AMT, 0))/F.QTY, 0)                                                                                                                                                                                                                             ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END AS ST_AMT, A.COMP_TYPE || A.REGION || A.SALE_TYPE || A.IV_TYPE AS COST_CD, 0 TAX_AMT ,                                                                                                                                                                                                                            ";
			/*미착금액추가 190517.jay*/
			sql += " CASE WHEN  TO_DATE('2019-04-30')-LL.IN_DT < 0 THEN D.LOC_AMT +                                                                                                          ";
			sql += "CASE                                                                                                                 ";
			sql += "WHEN D.BL_NO IS NOT NULL THEN                                                                                        ";
			sql += "        NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), MM.LC_NO, MM.LC_SEQ, D.BL_NO, D.BL_SEQ), 0) ";
			sql += "ELSE                                                                                                                 ";
			sql += "        NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), MM.LC_NO, MM.LC_SEQ), 0)                            ";
			sql += "END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)  ELSE 0 END         AS NON_AMT ,                     ";
// 	sql += "0 NON_AMT, ";
	sql += "0 PO_AMT ";
			sql += " FROM   E_APPROV_H_DISTR A                                                                                                                                                                                                                                                                                                                        ";
			sql += "       LEFT OUTER JOIN B_SL_PERIOND_VIEW I                                                                                                                                                                                                                                                                                                       ";
			sql += "       ON     A.COMP_ID    =I.COMP_ID                                                                                                                                                                                                                                                                                                            ";
			sql += "       AND    A.RISK_REF_NO=I.RISK_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN M_PO_DTL_DISTR B                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID      =B.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    A.APPROV_MGM_NO=B.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       LEFT OUTER JOIN M_BL_DTL_DISTR D                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     B.COMP_ID=D.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    B.PO_NO  =D.PO_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    B.PO_SEQ =D.PO_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_BL_HDR_DISTR J                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     D.COMP_ID=J.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =J.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       LEFT OUTER JOIN M_LC_DTL_DISTR MM                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     D.COMP_ID=MM.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    D.LC_NO  =MM.LC_NO                                                                                                                                                                                                                                                                                                                 ";
			sql += "       AND    D.LC_SEQ =MM.LC_SEQ                                                                                                                                                                                                                                                                                                                ";
			sql += "       LEFT OUTER JOIN M_LC_HDR_DISTR NN                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     MM.COMP_ID=NN.COMP_ID                                                                                                                                                                                                                                                                                                              ";
			sql += "       AND    MM.LC_NO  =NN.LC_NO                                                                                                                                                                                                                                                                                                                ";
			sql += "       LEFT OUTER JOIN M_CY_GR_D_DISTR E                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     D.COMP_ID=E.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =E.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    D.BL_SEQ =E.BL_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_CY_GR_H_DISTR LL                                                                                                                                                                                                                                                                                                        ";
			sql += "       ON     E.COMP_ID=LL.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    E.CY_NO  =LL.CY_NO                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_CC_DTL_DISTR G                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     D.COMP_ID=G.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =G.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    D.BL_SEQ =G.BL_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_GR_DISTR F                                                                                                                                                                                                                                                                                                              ";
			sql += "       ON     G.COMP_ID=F.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    G.CC_NO  =F.CC_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    G.CC_SEQ =F.CC_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       AND    MVMT_DT <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                             ";
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   COMP_ID, MVMT_NO, SUM(DN_QTY)DN_QTY, SUM(DN_BOX_QTY) DN_BOX_QTY                                                                                                                                                                                                                                                  ";
			sql += "                       FROM     M_GR_TO_DN_DISTR                                                                                                                                                                                                                                                                                                 ";
			sql += "                       WHERE    DN_DT<='" + V_DATE + "'                                                                                                                                                                                                                                                                                              ";
			sql += "                       GROUP BY MVMT_NO, COMP_ID                                                                                                                                                                                                                                                                                                 ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              H                                                                                                                                                                                                                                                                                                                                  ";
			sql += "       ON     F.COMP_ID=H.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    F.MVMT_NO=H.MVMT_NO                                                                                                                                                                                                                                                                                                                ";
			sql += "       LEFT OUTER JOIN B_ITEM_BF_DISTR OO                                                                                                                                                                                                                                                                                                        ";
			sql += "       ON     B.COMP_ID=OO.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    B.ITEM_CD=OO.ITEM_CD                                                                                                                                                                                                                                                                                                               ";
			sql += "       LEFT OUTER JOIN B_BIZ_HSPF QQ                                                                                                                                                                                                                                                                                                             ";
			sql += "       ON     A.COMP_ID       =QQ.COMP_ID                                                                                                                                                                                                                                                                                                        ";
			sql += "       AND    A.S_BP_CD       =QQ.BP_CD                                                                                                                                                                                                                                                                                                          ";
			sql += "WHERE  J.LOADING_DT          <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                      ";
			sql += "AND    E.QTY -NVL(H.DN_QTY, 0)>0                                                                                                                                                                                                                                                                                                                 ";
			sql += "AND    QQ.BP_NM           LIKE '%" + V_S_BP_NM + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    B.ITEM_CD           LIKE '%" + V_ITEM_CD + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.REGION            LIKE '%" + V_REGION + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.SALE_TYPE         LIKE '%" + V_SALE_TYPE + "%'                                                                                                                                                                                                                                                                                                                 ";
			sql += "AND    A.IV_TYPE           LIKE  '%" + V_IV_TYPE + "%'                                                                                                                                                                                                                                                                                                             ";
			sql += "AND                                                                                                                                                                                                                                                                                                                                              ";
			sql += "       (                                                                                                                                                                                                                                                                                                                                         ";
			sql += "              NN.LC_DOC_NO       LIKE '%" + V_LC_DOC_NO + "%'                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    NN.LC_DOC_NO IS NOT NULL                                                                                                                                                                                                                                                                                                           ";
			sql += "       )                                                                                                                                                                                                                                                                                                                                         ";
			sql += "AND    J.BL_DOC_NO LIKE '%" + V_BL_DOC_NO + "%'                                                                                                                                                                                                                                                                                                                    ";
			sql += "/* A.IV_TYPE='I' */                                                                                                                                                                                                                                                                                                                              ";
			sql += "UNION ALL                                                                                                                                                                                                                                                                                                                                        ";
			sql += "/*BL양수도  */                                                                                                                                                                                                                                                                                                                                      ";
			sql += "SELECT A.APPROV_MGM_NO, A.APPROV_NO, A.APPROV_NM, A.S_BP_CD, QQ.BP_NM, B.ITEM_CD,                                                                                                                                                                                                                                                                ";
			sql += "       OO.ITEM_NM, NN.LC_DOC_NO, J.BL_DOC_NO, F.IN_DT, NULL MVMT_DT, D.BOX_QTY-NVL(G.BOX_QTY, 0) BOX_QTY,                                                                                                                                                                                                                                        ";
			sql += "       D.BOX_WGT_UNIT, D.QTY                                                  -NVL(G.CC_QTY, 0) AS QTY, TO_DATE('" + V_DATE + "')-F.IN_DT S_DAY,                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT >=TO_DATE('" + V_DATE + "') - IN_DT                                                                                                                                                                                                                                                                                          ";
			sql += "              THEN D.LOC_AMT                    +                                                                                                                                                                                                                                                                                                ";
			sql += "                     CASE                                                                                                                                                                                                                                                                                                                        ";
			sql += "                            WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                             ";
			sql += "                            THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                     ";
			sql += "                            ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                 ";
			sql += "                     END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                                        ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END N_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "') -IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              THEN D.LOC_AMT                    +                                                                                                                                                                                                                                                                                                ";
			sql += "                     CASE                                                                                                                                                                                                                                                                                                                        ";
			sql += "                            WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                             ";
			sql += "                            THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                     ";
			sql += "                            ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                 ";
			sql += "                     END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                                        ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END O_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              AND    O_RT<TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              THEN D.LOC_AMT                   +                                                                                                                                                                                                                                                                                                 ";
			sql += "                     CASE                                                                                                                                                                                                                                                                                                                        ";
			sql += "                            WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                             ";
			sql += "                            THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                     ";
			sql += "                            ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                 ";
			sql += "                     END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                                        ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END L_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT >=TO_DATE('" + V_DATE + "') - IN_DT                                                                                                                                                                                                                                                                                          ";
			sql += "              THEN D.LOC_AMT                    +                                                                                                                                                                                                                                                                                                ";
			sql += "                     CASE                                                                                                                                                                                                                                                                                                                        ";
			sql += "                            WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                             ";
			sql += "                            THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                     ";
			sql += "                            ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                 ";
			sql += "                     END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                                        ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "') -IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              THEN D.LOC_AMT                    +                                                                                                                                                                                                                                                                                                ";
			sql += "                     CASE                                                                                                                                                                                                                                                                                                                        ";
			sql += "                            WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                             ";
			sql += "                            THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                     ";
			sql += "                            ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                 ";
			sql += "                     END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                                        ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              AND    O_RT<TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              THEN D.LOC_AMT                   +                                                                                                                                                                                                                                                                                                 ";
			sql += "                     CASE                                                                                                                                                                                                                                                                                                                        ";
			sql += "                            WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                             ";
			sql += "                            THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                     ";
			sql += "                            ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                 ";
			sql += "                     END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                                        ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END AS ST_AMT, A.COMP_TYPE || A.REGION || A.SALE_TYPE || A.IV_TYPE AS COST_CD, ROUND((D.LOC_AMT+NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0) +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0) )*NVL(TAX_RT, 0)/100, 0), 0 NON_AMT, 0 PO_AMT";
			sql += " FROM   E_APPROV_H_DISTR A                                                                                                                                                                                                                                                                                                                        ";
			sql += "       LEFT OUTER JOIN B_SL_PERIOND_VIEW I                                                                                                                                                                                                                                                                                                       ";
			sql += "       ON     A.COMP_ID    =I.COMP_ID                                                                                                                                                                                                                                                                                                            ";
			sql += "       AND    A.RISK_REF_NO=I.RISK_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN M_PO_DTL_DISTR B                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID      =B.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    A.APPROV_MGM_NO=B.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   COMP_ID, APPROV_MGM_NO, ITEM_CD, TAX_RT                                                                                                                                                                                                                                                                          ";
			sql += "                       FROM     E_APPROV_D_DISTR                                                                                                                                                                                                                                                                                                 ";
			sql += "                       GROUP BY APPROV_MGM_NO, ITEM_CD, TAX_RT, COMP_ID                                                                                                                                                                                                                                                                          ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              X                                                                                                                                                                                                                                                                                                                                  ";
			sql += "       ON     B.COMP_ID      =X.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    B.APPROV_MGM_NO=X.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       AND    B.ITEM_CD      =X.ITEM_CD                                                                                                                                                                                                                                                                                                          ";
			sql += "       LEFT OUTER JOIN M_LC_DTL_DISTR C                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID=C.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    B.PO_NO  =C.PO_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    B.PO_SEQ =C.PO_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_LC_HDR_DISTR NN                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     C.COMP_ID=NN.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    C.LC_NO  =NN.LC_NO                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_BL_DTL_DISTR D                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     C.COMP_ID=D.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    C.LC_NO  =D.LC_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    C.LC_SEQ =D.LC_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_BL_HDR_DISTR J                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     D.COMP_ID=J.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =J.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       LEFT OUTER JOIN M_CY_GR_D_DISTR E                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     D.COMP_ID=E.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =E.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    D.BL_SEQ =E.BL_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_CY_GR_H_DISTR F                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     E.COMP_ID=F.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    E.CY_NO  =F.CY_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    F.IN_DT <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                             ";
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   X.COMP_ID, BL_NO, BL_SEQ, SUM(QTY) CC_QTY, SUM(BOX_QTY)BOX_QTY                                                                                                                                                                                                                                                   ";
			sql += "                       FROM     M_CC_DTL_DISTR X, M_CC_HDR_DISTR Y                                                                                                                                                                                                                                                                               ";
			sql += "                       WHERE    X.COMP_ID=Y.COMP_ID                                                                                                                                                                                                                                                                                              ";
			sql += "                       AND      X.CC_NO  =Y.CC_NO                                                                                                                                                                                                                                                                                                ";
			sql += "                       AND      Y.ID_DT <='" + V_DATE + "'                                                                                                                                                                                                                                                                                           ";
			sql += "                       GROUP BY X.COMP_ID, BL_NO, BL_SEQ                                                                                                                                                                                                                                                                                         ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              G                                                                                                                                                                                                                                                                                                                                  ";
			sql += "       ON     D.COMP_ID =G.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    D.BL_NO   =G.BL_NO                                                                                                                                                                                                                                                                                                                 ";
			sql += "       AND    D.BL_SEQ  =G.BL_SEQ                                                                                                                                                                                                                                                                                                                ";
			sql += "       LEFT OUTER JOIN B_ITEM_BF_DISTR OO                                                                                                                                                                                                                                                                                                        ";
			sql += "       ON     B.COMP_ID=OO.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    B.ITEM_CD=OO.ITEM_CD                                                                                                                                                                                                                                                                                                               ";
			sql += "       LEFT OUTER JOIN B_BIZ_HSPF QQ                                                                                                                                                                                                                                                                                                             ";
			sql += "       ON     A.COMP_ID      =QQ.COMP_ID                                                                                                                                                                                                                                                                                                         ";
			sql += "       AND    A.S_BP_CD      =QQ.BP_CD                                                                                                                                                                                                                                                                                                           ";
			sql += "WHERE  J.LOADING_DT         <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                       ";
			sql += "AND    E.QTY       IS NOT NULL                                                                                                                                                                                                                                                                                                                   ";
			sql += "AND    F.CY_NO     IS NOT NULL                                                                                                                                                                                                                                                                                                                   ";
			sql += "AND    D.QTY-NVL(G.CC_QTY, 0)>0                                                                                                                                                                                                                                                                                                                  ";

			sql += "AND    QQ.BP_NM           LIKE '%" + V_S_BP_NM + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    B.ITEM_CD           LIKE '%" + V_ITEM_CD + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.REGION            LIKE '%" + V_REGION + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.SALE_TYPE         LIKE '%" + V_SALE_TYPE + "%'                                                                                                                                                                                                                                                                                                                 ";
			sql += "AND    A.IV_TYPE           LIKE  '%" + V_IV_TYPE + "%'                                                                                                                                                                                                                                                                                                             ";
			sql += "AND                                                                                                                                                                                                                                                                                                                                              ";
			sql += "       (                                                                                                                                                                                                                                                                                                                                         ";
			sql += "              NN.LC_DOC_NO       LIKE '%" + V_LC_DOC_NO + "%'                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    NN.LC_DOC_NO IS NOT NULL                                                                                                                                                                                                                                                                                                           ";
			sql += "       )                                                                                                                                                                                                                                                                                                                                         ";
			sql += "AND    J.BL_DOC_NO LIKE '%" + V_BL_DOC_NO + "%'                                                                                                                                                                                                                                                                                                                    ";

			sql += "UNION ALL                                                                                                                                                                                                                                                                                                                                        ";
			sql += "/*BL양수도 -- 190516수정  */                                                                                                                                                                                                                                                                                                                                      ";
			sql += "SELECT A.APPROV_MGM_NO, A.APPROV_NO, A.APPROV_NM, A.S_BP_CD, QQ.BP_NM, B.ITEM_CD,                                                                                                                                                                                                                                                                ";
			sql += "       OO.ITEM_NM, NULL LC_DOC_NO, J.BL_DOC_NO, F.IN_DT, NULL MVMT_DT, D.BOX_QTY-NVL(H.BOX_QTY, 0) BOX_QTY,                                                                                                                                                                                                                                      ";
			sql += "       D.BOX_WGT_UNIT, D.QTY                                                    -NVL(H.DN_QTY, 0) AS QTY, TO_DATE('" + V_DATE + "')-F.IN_DT S_DAY,                                                                                                                                                                                                   ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT >=TO_DATE('" + V_DATE + "') - IN_DT                                                                                                                                                                                                                                                                                          ";
			sql += "              THEN D.LOC_AMT                    +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                 ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END N_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "') -IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              THEN D.LOC_AMT                    +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                 ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END O_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              AND    O_RT<TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              THEN D.LOC_AMT                   +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                  ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END L_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT >=TO_DATE('" + V_DATE + "') - IN_DT                                                                                                                                                                                                                                                                                          ";
			sql += "              THEN D.LOC_AMT                    +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                 ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "') -IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                           ";
			sql += "              THEN D.LOC_AMT                    +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                 ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              AND    O_RT<TO_DATE('" + V_DATE + "')-IN_DT                                                                                                                                                                                                                                                                                            ";
			sql += "              THEN D.LOC_AMT                   +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                  ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END AS ST_AMT, A.COMP_TYPE || A.REGION || A.SALE_TYPE || A.IV_TYPE AS COST_CD, ROUND(D.LOC_AMT+NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0) *NVL(TAX_RT, 0)/100, 0), 0 NON_AMT, 0 PO_AMT                                                                                                               ";
			sql += " FROM   E_APPROV_H_DISTR A                                                                                                                                                                                                                                                                                                                        ";
			sql += "       LEFT OUTER JOIN B_SL_PERIOND_VIEW I                                                                                                                                                                                                                                                                                                       ";
			sql += "       ON     A.COMP_ID     =I.COMP_ID                                                                                                                                                                                                                                                                                                           ";
			sql += "       AND    A .RISK_REF_NO=I.RISK_NO                                                                                                                                                                                                                                                                                                           ";
			sql += "       LEFT OUTER JOIN M_PO_DTL_DISTR B                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID      =B.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    A.APPROV_MGM_NO=B.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   COMP_ID, APPROV_MGM_NO, ITEM_CD, TAX_RT                                                                                                                                                                                                                                                                          ";
			sql += "                       FROM     E_APPROV_D_DISTR                                                                                                                                                                                                                                                                                                 ";
			sql += "                       GROUP BY APPROV_MGM_NO, ITEM_CD, TAX_RT, COMP_ID                                                                                                                                                                                                                                                                          ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              X                                                                                                                                                                                                                                                                                                                                  ";
			sql += "       ON     B.COMP_ID      =X.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    B.APPROV_MGM_NO=X.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       AND    B.ITEM_CD      =X.ITEM_CD                                                                                                                                                                                                                                                                                                          ";
			sql += "       LEFT OUTER JOIN M_BL_DTL_DISTR D                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID=D.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    B.PO_NO  =D.PO_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    B.PO_SEQ =D.PO_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_BL_HDR_DISTR J                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     D.COMP_ID=J.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =J.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       LEFT OUTER JOIN M_CY_GR_D_DISTR E                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     D.COMP_ID=E.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =E.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    D.BL_SEQ =E.BL_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_CY_GR_H_DISTR F                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     E.COMP_ID=F.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    E.CY_NO  =F.CY_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    F.IN_DT <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                             ";
			/*
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   X.COMP_ID, BL_NO, BL_SEQ, SUM(QTY) CC_QTY, SUM(BOX_QTY) BOX_QTY                                                                                                                                                                                                                                                  ";
			sql += "                       FROM     M_CC_DTL_DISTR X, M_CC_HDR_DISTR Y                                                                                                                                                                                                                                                                               ";
			sql += "                       WHERE    X.COMP_ID=Y.COMP_ID                                                                                                                                                                                                                                                                                              ";
			sql += "                       AND      X.CC_NO  =Y.CC_NO                                                                                                                                                                                                                                                                                                ";
			sql += "                       AND      Y.ID_DT <='" + V_DATE + "'                                                                                                                                                                                                                                                                                           ";
			sql += "                       GROUP BY X.COMP_ID, BL_NO, BL_SEQ                                                                                                                                                                                                                                                                                         ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              G                                                                                                                                                                                                                                                                                                                                  ";
			sql += "       ON     D.COMP_ID =G.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    D.BL_NO   =G.BL_NO                                                                                                                                                                                                                                                                                                                 ";
			sql += "       AND    D.BL_SEQ  =G.BL_SEQ                                                                                                                                                                                                                                                                                                                ";
			*/

			sql += " LEFT OUTER JOIN M_CC_DTL_DISTR G1 ";
			sql += "    ON     D.COMP_ID=G1.COMP_ID ";
			sql += "    AND    D.BL_NO  =G1.BL_NO ";
			sql += "    AND    D.BL_SEQ =G1.BL_SEQ ";
			sql += "    LEFT OUTER JOIN M_GR_DISTR F1  ";
			sql += "    ON     G1.COMP_ID=F1.COMP_ID  ";
			sql += "    AND    G1.CC_NO  =F1.CC_NO  ";
			sql += "    AND    G1.CC_SEQ =F1.CC_SEQ  ";
			sql += "    AND    MVMT_DT <= '" + V_DATE + "' ";
			sql += "    LEFT OUTER JOIN  ";
			sql += "           (  ";
			sql += "                    SELECT   COMP_ID, MVMT_NO, SUM(DN_QTY)DN_QTY, SUM(DN_BOX_QTY) BOX_QTY  ";
			sql += "                    FROM     M_GR_TO_DN_DISTR  ";
			sql += "                    WHERE    DN_DT<='" + V_DATE + "' ";
			sql += "                    GROUP BY MVMT_NO, COMP_ID  ";
			sql += "           )  ";
			sql += "           H  ";
			sql += "    ON     F1.COMP_ID=H.COMP_ID  ";
			sql += "    AND    F1.MVMT_NO=H.MVMT_NO  ";
			sql += "       LEFT OUTER JOIN B_ITEM_BF_DISTR OO                                                                                                                                                                                                                                                                                                        ";
			sql += "       ON     B.COMP_ID=OO.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    B.ITEM_CD=OO.ITEM_CD                                                                                                                                                                                                                                                                                                               ";
			sql += "       LEFT OUTER JOIN B_BIZ_HSPF QQ                                                                                                                                                                                                                                                                                                             ";
			sql += "       ON     A.COMP_ID       =QQ.COMP_ID                                                                                                                                                                                                                                                                                                        ";
			sql += "       AND    A.S_BP_CD       =QQ.BP_CD                                                                                                                                                                                                                                                                                                          ";
			sql += "WHERE  J.LOADING_DT          <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                      ";
			sql += "AND    E.QTY        IS NOT NULL                                                                                                                                                                                                                                                                                                                  ";
			sql += "AND    F.CY_NO      IS NOT NULL                                                                                                                                                                                                                                                                                                                  ";
			// 			sql += "AND    D.QTY        -NVL(G.CC_QTY, 0)>0                                                                                                                                                                                                                                                                                                          ";
			sql += "AND    B.PO_NO NOT IN                                                                                                                                                                                                                                                                                                                            ";
			sql += "       (                                                                                                                                                                                                                                                                                                                                         ";
			sql += "              SELECT PO_NO                                                                                                                                                                                                                                                                                                                       ";
			sql += "              FROM   M_LC_DTL_DISTR                                                                                                                                                                                                                                                                                                              ";
			sql += "       )                                                                                                                                                                                                                                                                                                                                         ";

			sql += "AND    QQ.BP_NM           LIKE '%" + V_S_BP_NM + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    B.ITEM_CD           LIKE '%" + V_ITEM_CD + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.REGION            LIKE '%" + V_REGION + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.SALE_TYPE         LIKE '%" + V_SALE_TYPE + "%'                                                                                                                                                                                                                                                                                                                 ";
			sql += "AND    A.IV_TYPE           LIKE  '%" + V_IV_TYPE + "%'                                                                                                                                                                                                                                                                                                             ";
			sql += "AND    J.BL_DOC_NO LIKE '%" + V_BL_DOC_NO + "%'                                                                                                                                                                                                                                                                                                                    ";

			sql += " AND (D.BOX_QTY-NVL(H.BOX_QTY, 0) > 0 ";
			sql += " AND  D.QTY                                                    -NVL(H.DN_QTY, 0) > 100) ";

			sql += "/*국내상품인경우  */                                                                                                                                                                                                                                                                                                                                    ";
			sql += "UNION ALL                                                                                                                                                                                                                                                                                                                                        ";
			sql += "SELECT A.APPROV_MGM_NO, A.APPROV_NO, A.APPROV_NM, A.S_BP_CD, QQ.BP_NM, B.ITEM_CD,                                                                                                                                                                                                                                                                ";
			sql += "       OO.ITEM_NM, NULL LC_DOC_NO, NULL BL_DOC_NO, C.MVMT_DT IN_DT, C.MVMT_DT, C.BOX_QTY-NVL(D.DN_BOX_QTY, 0) BOX_QTY,                                                                                                                                                                                                                           ";
			sql += "       C.BOX_WGT_UNIT, C.QTY                                                            -NVL(D.DN_QTY, 0) AS QTY, TO_DATE('" + V_DATE + "')-C.MVMT_DT S_DAY,                                                                                                                                                                                         ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT>=TO_DATE('" + V_DATE + "')-C.MVMT_DT                                                                                                                                                                                                                                                                                         ";
			sql += "              THEN ROUND((C.QTY               -NVL(D.DN_QTY, 0))*(C.LOC_AMT)/C.QTY, 0)                                                                                                                                                                                                                                                           ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END N_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "') -C.MVMT_DT                                                                                                                                                                                                                                                                                       ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "')-C.MVMT_DT                                                                                                                                                                                                                                                                                       ";
			sql += "              THEN ROUND((C.QTY                 -NVL(D.DN_QTY, 0))*C.LOC_AMT/C.QTY, 0)                                                                                                                                                                                                                                                           ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END O_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "') -C.MVMT_DT                                                                                                                                                                                                                                                                                       ";
			sql += "              AND    O_RT< TO_DATE('" + V_DATE + "')-C.MVMT_DT                                                                                                                                                                                                                                                                                       ";
			sql += "              THEN ROUND((C.QTY                 -NVL(D.DN_QTY, 0))*C.LOC_AMT/C.QTY, 0)                                                                                                                                                                                                                                                           ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END L_ST_AMT,                                                                                                                                                                                                                                                                                                                             ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN N_RT>=TO_DATE('" + V_DATE + "')-C.MVMT_DT                                                                                                                                                                                                                                                                                         ";
			sql += "              THEN ROUND((C.QTY               -NVL(D.DN_QTY, 0))*(C.LOC_AMT)/C.QTY, 0)                                                                                                                                                                                                                                                           ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN O_RT >=TO_DATE('" + V_DATE + "')  -C.MVMT_DT                                                                                                                                                                                                                                                                                      ";
			sql += "              AND    N_RT< TO_DATE('" + V_DATE + "') -C.MVMT_DT                                                                                                                                                                                                                                                                                      ";
			sql += "              THEN ROUND((C.QTY                  -NVL(D.DN_QTY, 0))*C.LOC_AMT/C.QTY, 0)                                                                                                                                                                                                                                                          ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END +                                                                                                                                                                                                                                                                                                                                     ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN L_RT >=TO_DATE('" + V_DATE + "') -C.MVMT_DT                                                                                                                                                                                                                                                                                       ";
			sql += "              AND    O_RT< TO_DATE('" + V_DATE + "')-C.MVMT_DT                                                                                                                                                                                                                                                                                       ";
			sql += "              THEN ROUND((C.QTY                 -NVL(D.DN_QTY, 0))*C.LOC_AMT/C.QTY, 0)                                                                                                                                                                                                                                                           ";
			sql += "              ELSE 0                                                                                                                                                                                                                                                                                                                             ";
			sql += "       END AS ST_AMT, A.COMP_TYPE || A.REGION || A.SALE_TYPE || A.IV_TYPE AS COST_CD, 0 TAX_AMT, 0 NON_AMT, 0                                                                                                                                                                                                                                    ";
			sql += " FROM   E_APPROV_H_DISTR A                                                                                                                                                                                                                                                                                                                        ";
			sql += "       LEFT OUTER JOIN B_SL_PERIOND_VIEW I                                                                                                                                                                                                                                                                                                       ";
			sql += "       ON     A.COMP_ID    =I.COMP_ID                                                                                                                                                                                                                                                                                                            ";
			sql += "       AND    A.RISK_REF_NO=I.RISK_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN M_PO_HDR_DISTR X                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.APPROV_MGM_NO=X.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       LEFT OUTER JOIN M_PO_DTL_DISTR B                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID      =B.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    A.APPROV_MGM_NO=B.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       AND    X.PO_NO        =B.PO_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN M_GR_DISTR C                                                                                                                                                                                                                                                                                                              ";
			sql += "       ON     B.COMP_ID=C.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    B.PO_NO  =C.PO_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    B.PO_SEQ =C.PO_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   COMP_ID, MVMT_NO, SUM(DN_QTY)DN_QTY, SUM(DN_BOX_QTY) DN_BOX_QTY                                                                                                                                                                                                                                                  ";
			sql += "                       FROM     M_GR_TO_DN_DISTR                                                                                                                                                                                                                                                                                                 ";
			sql += "                       WHERE    DN_DT<='" + V_DATE + "'                                                                                                                                                                                                                                                                                              ";
			sql += "                       GROUP BY COMP_ID, MVMT_NO                                                                                                                                                                                                                                                                                                 ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              D                                                                                                                                                                                                                                                                                                                                  ";
			sql += "       ON     C.COMP_ID=D.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    C.MVMT_NO=D.MVMT_NO                                                                                                                                                                                                                                                                                                                ";
			sql += "       LEFT OUTER JOIN B_ITEM_BF_DISTR OO                                                                                                                                                                                                                                                                                                        ";
			sql += "       ON     B.COMP_ID=OO.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    B.ITEM_CD=OO.ITEM_CD                                                                                                                                                                                                                                                                                                               ";
			sql += "       LEFT OUTER JOIN B_BIZ_HSPF QQ                                                                                                                                                                                                                                                                                                             ";
			sql += "       ON     A.COMP_ID=QQ.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    A.S_BP_CD=QQ.BP_CD                                                                                                                                                                                                                                                                                                                 ";
			sql += "WHERE  A.IV_TYPE       ='L'                                                                                                                                                                                                                                                                                                                      ";
			sql += "AND    X.PO_NO NOT IN                                                                                                                                                                                                                                                                                                                            ";
			sql += "       (                                                                                                                                                                                                                                                                                                                                         ";
			sql += "              SELECT PO_NO                                                                                                                                                                                                                                                                                                                       ";
			sql += "              FROM   M_BL_DTL_DISTR                                                                                                                                                                                                                                                                                                              ";
			sql += "       )                                                                                                                                                                                                                                                                                                                                         ";
			sql += "AND    X.PO_DT       <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    C.QTY          >0                                                                                                                                                                                                                                                                                                                         ";

			sql += "AND    QQ.BP_NM           LIKE '%" + V_S_BP_NM + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    B.ITEM_CD           LIKE '%" + V_ITEM_CD + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.REGION            LIKE '%" + V_REGION + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.SALE_TYPE         LIKE '%" + V_SALE_TYPE + "%'                                                                                                                                                                                                                                                                                                                 ";
			sql += "AND    A.IV_TYPE           LIKE  '%" + V_IV_TYPE + "%'                                                                                                                                                                                                                                                                                                             ";
			sql += "AND CASE WHEN '" + V_BL_DOC_NO + "' IS NULL THEN 'Y' ELSE 'N' END ='Y' ";
			sql += "AND CASE WHEN '" + V_LC_DOC_NO + "' IS NULL THEN 'Y' ELSE 'N' END ='Y' ";
			sql += "UNION ALL                                                                                                                                                                                                                                                                                                                                        ";
			sql += "SELECT A.APPROV_MGM_NO, A.APPROV_NO, A.APPROV_NM, A.S_BP_CD, QQ.BP_NM, B.ITEM_CD,                                                                                                                                                                                                                                                                ";
			sql += "       OO.ITEM_NM, NN.LC_DOC_NO LC_DOC_NO, J.BL_DOC_NO BL_DOC_NO, NULL IN_DT, NULL, D.BOX_QTY BOX_QTY,                                                                                                                                                                                                                                           ";
			sql += "       D.BOX_WGT_UNIT, D.QTY AS QTY, 0 S_DAY, 0 N_ST_AMT, 0 O_ST_AMT, 0 L_ST_AMT,                                                                                                                                                                                                                                                                ";
			sql += "       0                     AS ST_AMT, A.COMP_TYPE || A.REGION || A.SALE_TYPE || A.IV_TYPE AS COST_CD, ROUND((D.LOC_AMT +                                                                                                                                                                                                                       ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                                           ";
			sql += "              THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                   ";
			sql += "              ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                               ";
			sql += "       END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0) )*NVL(TAX_RT, 0)/100, 0) TAX_AMT, D.LOC_AMT +                                                                                                                                                                                                        ";
			sql += "       CASE                                                                                                                                                                                                                                                                                                                                      ";
			sql += "              WHEN D.BL_NO IS NOT NULL                                                                                                                                                                                                                                                                                                           ";
			sql += "              THEN NVL(UFN_GET_CHARGE_AMT_LC_BY_BL(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ, D.BL_NO, D.BL_SEQ), 0)                                                                                                                                                                                                                   ";
			sql += "              ELSE NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0)                                                                                                                                                                                                                                               ";
			sql += "       END +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), D.BL_NO, D.BL_SEQ), 0) NON_AMT, 0                                                                                                                                                                                                                                                   ";
			sql += " FROM   E_APPROV_H_DISTR A                                                                                                                                                                                                                                                                                                                        ";
			sql += "       LEFT OUTER JOIN B_SL_PERIOND_VIEW I                                                                                                                                                                                                                                                                                                       ";
			sql += "       ON     A.COMP_ID    =I.COMP_ID                                                                                                                                                                                                                                                                                                            ";
			sql += "       AND    A.RISK_REF_NO=I.RISK_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN M_PO_HDR_DISTR X                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.APPROV_MGM_NO=X.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       LEFT OUTER JOIN M_PO_DTL_DISTR B                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID      =B.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    A.APPROV_MGM_NO=B.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       AND    X.PO_NO        =B.PO_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   COMP_ID, APPROV_MGM_NO, ITEM_CD, TAX_RT                                                                                                                                                                                                                                                                          ";
			sql += "                       FROM     E_APPROV_D_DISTR                                                                                                                                                                                                                                                                                                 ";
			sql += "                       GROUP BY APPROV_MGM_NO, ITEM_CD, TAX_RT, COMP_ID                                                                                                                                                                                                                                                                          ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              XX                                                                                                                                                                                                                                                                                                                                 ";
			sql += "       ON     B.COMP_ID      =XX.COMP_ID                                                                                                                                                                                                                                                                                                         ";
			sql += "       AND    B.APPROV_MGM_NO=XX.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                   ";
			sql += "       AND    B.ITEM_CD      =XX.ITEM_CD                                                                                                                                                                                                                                                                                                         ";
			sql += "       LEFT OUTER JOIN M_BL_DTL_DISTR D                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID=D.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    B.PO_NO  =D.PO_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    B.PO_SEQ =D.PO_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_BL_HDR_DISTR J                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     D.COMP_ID=J.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.BL_NO  =J.BL_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       LEFT OUTER JOIN M_LC_DTL_DISTR C                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID=C.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    D.LC_NO  =C.LC_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    D.LC_SEQ =C.LC_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_LC_HDR_DISTR NN                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     C.COMP_ID=NN.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    C.LC_NO  =NN.LC_NO                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN B_ITEM_BF_DISTR OO                                                                                                                                                                                                                                                                                                        ";
			sql += "       ON     B.COMP_ID=OO.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    B.ITEM_CD=OO.ITEM_CD                                                                                                                                                                                                                                                                                                               ";
			sql += "       LEFT OUTER JOIN B_BIZ_HSPF QQ                                                                                                                                                                                                                                                                                                             ";
			sql += "       ON     A.COMP_ID =QQ.COMP_ID                                                                                                                                                                                                                                                                                                              ";
			sql += "       AND    A.S_BP_CD =QQ.BP_CD                                                                                                                                                                                                                                                                                                                ";

			/*미착*/
			sql += "WHERE  D.BL_NO NOT IN                                                                                                                                                                                                                                                                                                                            ";
			sql += "       (                                                                                                                                                                                                                                                                                                                                         ";
			sql += "              SELECT BL_NO                                                                                                                                                                                                                                                                                                                       ";
			sql += "              FROM   M_CY_GR_D_DISTR                                                                                                                                                                                                                                                                                                             ";
			sql += "       )                                                                                                                                                                                                                                                                                                                                         ";
			sql += "AND    X.PO_DT       <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    D.QTY          >0                                                                                                                                                                                                                                                                                                                         ";

			sql += "AND    QQ.BP_NM           LIKE '%" + V_S_BP_NM + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    B.ITEM_CD           LIKE '%" + V_ITEM_CD + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.REGION            LIKE '%" + V_REGION + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.SALE_TYPE         LIKE '%" + V_SALE_TYPE + "%'                                                                                                                                                                                                                                                                                                                 ";
			sql += "AND    A.IV_TYPE           LIKE  '%" + V_IV_TYPE + "%'                                                                                                                                                                                                                                                                                                             ";
			sql += " AND J.BL_DOC_NO LIKE '%" + V_BL_DOC_NO + "%'"; //COMGEN 추가
			sql += " AND NN.LC_DOC_NO LIKE '%" + V_LC_DOC_NO + "%'"; //COMGEN 추가

			sql += "UNION ALL                                                                                                                                                                                                                                                                                                                                        ";
			sql += "SELECT A.APPROV_MGM_NO, A.APPROV_NO, A.APPROV_NM, A.S_BP_CD, QQ.BP_NM, B.ITEM_CD,                                                                                                                                                                                                                                                                ";
			sql += "       OO.ITEM_NM, NN.LC_DOC_NO LC_DOC_NO, NULL BL_DOC_NO, NULL IN_DT, NULL, 0 BOX_QTY,                                                                                                                                                                                                                                                          ";
			sql += "       0 BOX_WGT_UNIT, C.QTY AS QTY, 0 S_DAY, 0 N_ST_AMT, 0 O_ST_AMT, 0 L_ST_AMT,                                                                                                                                                                                                                                                                ";
			sql += "       0                     AS ST_AMT, A.COMP_TYPE || A.REGION || A.SALE_TYPE || A.IV_TYPE AS COST_CD, ROUND((C.LOC_AMT +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0) )*NVL(TAX_RT, 0)/100, 0) TAX_AMT, C.LOC_AMT +NVL(UFN_GET_CHARGE_AMT(A.COMP_ID, TO_DATE('" + V_DATE + "'), C.LC_NO, C.LC_SEQ), 0) NON_AMT, 0        ";
			sql += " FROM   E_APPROV_H_DISTR A                                                                                                                                                                                                                                                                                                                        ";
			sql += "       LEFT OUTER JOIN B_SL_PERIOND_VIEW I                                                                                                                                                                                                                                                                                                       ";
			sql += "       ON     A.COMP_ID    =I.COMP_ID                                                                                                                                                                                                                                                                                                            ";
			sql += "       AND    A.RISK_REF_NO=I.RISK_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN M_PO_HDR_DISTR X                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.APPROV_MGM_NO=X.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       LEFT OUTER JOIN M_PO_DTL_DISTR B                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID      =B.COMP_ID                                                                                                                                                                                                                                                                                                          ";
			sql += "       AND    A.APPROV_MGM_NO=B.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                    ";
			sql += "       AND    X.PO_NO        =B.PO_NO                                                                                                                                                                                                                                                                                                            ";
			sql += "       LEFT OUTER JOIN                                                                                                                                                                                                                                                                                                                           ";
			sql += "              (                                                                                                                                                                                                                                                                                                                                  ";
			sql += "                       SELECT   COMP_ID, APPROV_MGM_NO, ITEM_CD, TAX_RT                                                                                                                                                                                                                                                                          ";
			sql += "                       FROM     E_APPROV_D_DISTR                                                                                                                                                                                                                                                                                                 ";
			sql += "                       GROUP BY APPROV_MGM_NO, ITEM_CD, TAX_RT, COMP_ID                                                                                                                                                                                                                                                                          ";
			sql += "              )                                                                                                                                                                                                                                                                                                                                  ";
			sql += "              XX                                                                                                                                                                                                                                                                                                                                 ";
			sql += "       ON     B.COMP_ID      =XX.COMP_ID                                                                                                                                                                                                                                                                                                         ";
			sql += "       AND    B.APPROV_MGM_NO=XX.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                   ";
			sql += "       AND    B.ITEM_CD      =XX.ITEM_CD                                                                                                                                                                                                                                                                                                         ";
			sql += "       LEFT OUTER JOIN M_LC_DTL_DISTR C                                                                                                                                                                                                                                                                                                          ";
			sql += "       ON     A.COMP_ID=C.COMP_ID                                                                                                                                                                                                                                                                                                                ";
			sql += "       AND    B.PO_NO  =C.PO_NO                                                                                                                                                                                                                                                                                                                  ";
			sql += "       AND    B.PO_SEQ =C.PO_SEQ                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN M_LC_HDR_DISTR NN                                                                                                                                                                                                                                                                                                         ";
			sql += "       ON     C.COMP_ID=NN.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    C.LC_NO  =NN.LC_NO                                                                                                                                                                                                                                                                                                                 ";
			sql += "       LEFT OUTER JOIN B_ITEM_BF_DISTR OO                                                                                                                                                                                                                                                                                                        ";
			sql += "       ON     B.COMP_ID=OO.COMP_ID                                                                                                                                                                                                                                                                                                               ";
			sql += "       AND    B.ITEM_CD=OO.ITEM_CD                                                                                                                                                                                                                                                                                                               ";
			sql += "       LEFT OUTER JOIN B_BIZ_HSPF QQ                                                                                                                                                                                                                                                                                                             ";
			sql += "       ON     A.COMP_ID =QQ.COMP_ID                                                                                                                                                                                                                                                                                                              ";
			sql += "       AND    A.S_BP_CD =QQ.BP_CD                                                                                                                                                                                                                                                                                                                ";
			sql += "WHERE  C.LC_NO || TO_CHAR(LC_SEQ) NOT IN                                                                                                                                                                                                                                                                                                         ";
			sql += "       (                                                                                                                                                                                                                                                                                                                                         ";
			sql += "              SELECT LC_NO ||TO_CHAR(LC_SEQ)                                                                                                                                                                                                                                                                                                     ";
			sql += "              FROM   M_BL_DTL_DISTR                                                                                                                                                                                                                                                                                                              ";
			sql += "       )                                                                                                                                                                                                                                                                                                                                         ";
			sql += "AND    X.PO_DT       <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    C.QTY          >0                                                                                                                                                                                                                                                                                                                         ";

			sql += "AND    QQ.BP_NM           LIKE '%" + V_S_BP_NM + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    B.ITEM_CD           LIKE '%" + V_ITEM_CD + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND CASE WHEN '" + V_BL_DOC_NO + "' IS NULL THEN 'Y' ELSE 'N' END ='Y' ";
			sql += " AND NN.LC_DOC_NO LIKE '%" + V_LC_DOC_NO + "%'"; //COMGEN 추가

			sql += "UNION ALL                                                                                                                                                                                                                                                                                                                                        ";
			sql += "SELECT   A.APPROV_MGM_NO, A.APPROV_NO, A.APPROV_NM, A.S_BP_CD, QQ.BP_NM, B.ITEM_CD,                                                                                                                                                                                                                                                              ";
			sql += "         OO.ITEM_NM, NULL LC_DOC_NO, NULL BL_DOC_NO, NULL IN_DT, NULL, 0 BOX_QTY,                                                                                                                                                                                                                                                                ";
			sql += "         0 BOX_WGT_UNIT, B.PO_QTY AS QTY, 0 S_DAY, 0 N_ST_AMT, 0 O_ST_AMT, 0 L_ST_AMT,                                                                                                                                                                                                                                                           ";
			sql += "         0                        AS ST_AMT, A.COMP_TYPE || A.REGION || A.SALE_TYPE || A.IV_TYPE AS COST_CD, 0 TAX_AMT, 0 NON_AMT, B.PO_LOC_AMT PO_AMT                                                                                                                                                                                                   ";
			sql += " FROM     E_APPROV_H_DISTR A                                                                                                                                                                                                                                                                                                                      ";
			sql += "         LEFT OUTER JOIN B_SL_PERIOND_VIEW I                                                                                                                                                                                                                                                                                                     ";
			sql += "         ON       A.COMP_ID    =I.COMP_ID                                                                                                                                                                                                                                                                                                        ";
			sql += "         AND      A.RISK_REF_NO=I.RISK_NO                                                                                                                                                                                                                                                                                                        ";
			sql += "         LEFT OUTER JOIN M_PO_HDR_DISTR X                                                                                                                                                                                                                                                                                                        ";
			sql += "         ON       A.APPROV_MGM_NO=X.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                ";
			sql += "         LEFT OUTER JOIN M_PO_DTL_DISTR B                                                                                                                                                                                                                                                                                                        ";
			sql += "         ON       A.COMP_ID      =B.COMP_ID                                                                                                                                                                                                                                                                                                      ";
			sql += "         AND      A.APPROV_MGM_NO=B.APPROV_MGM_NO                                                                                                                                                                                                                                                                                                ";
			sql += "         AND      X.PO_NO        =B.PO_NO                                                                                                                                                                                                                                                                                                        ";
			sql += "         LEFT OUTER JOIN B_ITEM_BF_DISTR OO                                                                                                                                                                                                                                                                                                      ";
			sql += "         ON       B.COMP_ID=OO.COMP_ID                                                                                                                                                                                                                                                                                                           ";
			sql += "         AND      B.ITEM_CD=OO.ITEM_CD                                                                                                                                                                                                                                                                                                           ";
			sql += "         LEFT OUTER JOIN B_BIZ_HSPF QQ                                                                                                                                                                                                                                                                                                           ";
			sql += "         ON       A.COMP_ID    =QQ.COMP_ID                                                                                                                                                                                                                                                                                                       ";
			sql += "         AND      A.S_BP_CD    =QQ.BP_CD                                                                                                                                                                                                                                                                                                         ";
			sql += "WHERE    SUBSTR(PAY_METH, 0, 1)='L'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND      B.PO_NO ||TO_CHAR(PO_SEQ) NOT IN                                                                                                                                                                                                                                                                                                        ";
			sql += "         (                                                                                                                                                                                                                                                                                                                                       ";
			sql += "                SELECT PO_NO || TO_CHAR(PO_SEQ)                                                                                                                                                                                                                                                                                                  ";
			sql += "                FROM   M_LC_DTL_DISTR                                                                                                                                                                                                                                                                                                            ";
			sql += "         )                                                                                                                                                                                                                                                                                                                                       ";
			sql += "AND      X.PO_DT       <='" + V_DATE + "'                                                                                                                                                                                                                                                                                                            ";

			sql += "AND    QQ.BP_NM           LIKE '%" + V_S_BP_NM + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    B.ITEM_CD           LIKE '%" + V_ITEM_CD + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.REGION            LIKE '%" + V_REGION + "%'                                                                                                                                                                                                                                                                                                              ";
			sql += "AND    A.SALE_TYPE         LIKE '%" + V_SALE_TYPE + "%'                                                                                                                                                                                                                                                                                                                 ";
			sql += "AND    A.IV_TYPE           LIKE  '%" + V_IV_TYPE + "%'                                                                                                                                                                                                                                                                                                             ";
			sql += "AND CASE WHEN '" + V_BL_DOC_NO + "' IS NULL THEN 'Y' ELSE 'N' END ='Y' ";
			sql += "AND CASE WHEN '" + V_LC_DOC_NO + "' IS NULL THEN 'Y' ELSE 'N' END ='Y' ";
			sql += "AND      B.PO_QTY       >0                                                                                                                                                                                                                                                                                                                       ";
			sql += "ORDER BY QQ.BP_NM, A.APPROV_NO, B.ITEM_CD                                                                                                                                                                                                                                                                                                        ";

			System.out.println(sql);
			rs = stmt.executeQuery(sql);

			while (rs.next()) {
				subObject = new JSONObject();
				subObject.put("APPROV_MGM_NO", rs.getString("APPROV_MGM_NO"));
				subObject.put("APPROV_NO", rs.getString("APPROV_NO"));
				subObject.put("APPROV_NM", rs.getString("APPROV_NM"));
				subObject.put("S_BP_CD", rs.getString("S_BP_CD"));
				subObject.put("BP_NM", rs.getString("BP_NM"));
				subObject.put("ITEM_CD", rs.getString("ITEM_CD"));
				subObject.put("ITEM_NM", rs.getString("ITEM_NM"));
				subObject.put("LC_DOC_NO", rs.getString("LC_DOC_NO"));
				subObject.put("BL_DOC_NO", rs.getString("BL_DOC_NO"));
				subObject.put("IN_DT", rs.getString("IN_DT"));
				subObject.put("MVMT_DT", rs.getString("MVMT_DT"));
				subObject.put("BOX_QTY", rs.getString("BOX_QTY"));
				subObject.put("BOX_WGT_UNIT", rs.getString("BOX_WGT_UNIT"));
				subObject.put("QTY", rs.getString("QTY"));
				subObject.put("S_DAY", rs.getString("S_DAY"));
				subObject.put("N_ST_AMT", rs.getString("N_ST_AMT"));
				subObject.put("O_ST_AMT", rs.getString("O_ST_AMT"));
				subObject.put("L_ST_AMT", rs.getString("L_ST_AMT"));
				subObject.put("ST_AMT", rs.getString("ST_AMT"));
				subObject.put("COST_CD", rs.getString("COST_CD"));
				subObject.put("TAX_AMT", rs.getString("TAX_AMT"));
				subObject.put("PO_AMT", rs.getString("PO_AMT"));
				subObject.put("NON_AMT", rs.getString("NON_AMT"));

				jsonArray.add(subObject);
			}

			jsonObject.put("success", true);
			jsonObject.put("resultList", jsonArray);
			// 			System.out.println(jsonObject);

			response.setContentType("text/plain; charset=UTF-8");
			PrintWriter pw = response.getWriter();
			pw.print(jsonObject);
			pw.flush();
			pw.close();
			//출고요청서 번호 채번

		}
	} catch (Exception e) {
		response.setContentType("text/plain; charset=UTF-8");
		PrintWriter pw = response.getWriter();
		pw.print(e.toString());
		pw.flush();
		pw.close();

		e.printStackTrace();
	} finally {
		if (cs != null) try {
			cs.close();
		} catch (SQLException ex) {}
		if (cs2 != null) try {
			cs2.close();
		} catch (SQLException ex) {}
		if (rs != null) try {
			rs.close();
		} catch (SQLException ex) {}
		if (stmt != null) try {
			stmt.close();
		} catch (SQLException ex) {}
		if (conn != null) try {
			conn.close();
		} catch (SQLException ex) {}
	}
%>


