/*
 * File: app/controller/MyGridController.js
 *
 * This file was generated by Sencha Architect version 4.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('M_GR_HSPF.controller.MyGridController', {
    extend: 'Ext.app.Controller',

    stores: [
        'MyStore', 'MyStore1'
    ],

    control: {
        "#gridAddBtn": {
            click: 'gridAddBtnClick'
        },
        "#gridDelBtn": {
            click: 'gridDelBtnClick'
        },
        "#xlsxDown": {
            click: 'xlsxDownClick'
        },
        "#gridInBtn": {
            click: 'gridInBtnClick'
        }
    },

    /* 입고등록 */
    /* MyStore : [ M_GR_HSPF ] */
    
    /*[ + ] 버튼*/
    gridAddBtnClick: function(button, e, eOpts) {
        var popup = Ext.create("M_GR_HSPF.view.WinAddRow");
        popup.show();
        Ext.getCmp('rowCount').setValue(1);
    },

    /*[ - ] 버튼*/
    gridDelBtnClick: function(button, e, eOpts) {
        var store = Ext.getStore('MyStore');
    	var gridRecord = Ext.getCmp('myGrid').getSelectionModel().getSelection();
    	
    		if(gridRecord.length > 0) {
        		Ext.Msg.confirm('확인','삭제하시겠습니까?', function(button){
    			if(button == 'yes') {
    				store.remove(gridRecord);
//                				for(var i=0; i<gridRecord.length; i++) {
//                		    		if(gridRecord[i].data['V_TYPE']=='V') {
//                		    			gridRecord[i].data['V_TYPE'] = 'D';
//                		    		}
//                		    	}
//                		    	store.sync({
//                					params: {
//                						V_USR_ID : 'admin',//parent.Ext.getCmp('GUSER_ID').getValue(),
//                					},
//                		    		callback: function(records, operation, success) {
//                		    			store.reload();
//                					}
//                		    	});
    			}
        		});
        	}
    	
    },

    /*[ 엑셀다운 ] 버튼*/
    xlsxDownClick: function(button, e, eOpts) {
        var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
            	var grid = Ext.getCmp('myGrid');
            	grid.saveDocumentAs({
                    type: 'xlsx',
                    title: '입고등록', //엑셀내타이틀
                    fileName: currentDate+'.xlsx' //엑셀파일이름
        		});
    },

    /*[ 입고등록 ] 버튼*/
    gridInBtnClick: function(button, e, eOpts) {
    	var store = this.getMyStoreStore();
    	var store1 = this.getMyStore1Store();
    	var gridRecord = Ext.getCmp('myGrid').getSelectionModel().getSelection();
    	var flag = '';
    	var msg = '';
    	var GR_DT = Ext.Date.format(Ext.getCmp('V_GR_DT').getValue(),'Y-m-d');
    	
    	for(var i=0; i<gridRecord.length; i++) {
			if (gridRecord[i].data['GR_QTY'] == 0) {
				flag = 'F';
				msg = ' 입고수량을 확인하세요.<br>' + gridRecord[i].data['PO_NO'] +', '+ gridRecord[i].data['PO_SEQ'];
				break;
			} else if (gridRecord[i].data['HOPE_SL_CD'] == undefined) {
				flag = 'F';
				msg = ' 창고를 선택하세요.<br>' + gridRecord[i].data['PO_NO'] +', '+ gridRecord[i].data['PO_SEQ'];
				break;
			} else {
				flag = 'T';
				if(gridRecord[i].data['V_TYPE'] == 'V') {
					gridRecord[i].set('V_TYPE', 'LI');
				}
			}
		}
    	
    	if(gridRecord.length > 0) {
    		if(flag == 'T') {
    		Ext.MessageBox.confirm('확인', '입고등록 하시겠습니까?<br>입고일자: '+GR_DT, function(btn) {
    			if(btn == 'yes') {
						store.sync({
							params : {
								V_TYPE : 'SYNC',
								V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
								V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
								V_GR_DT: GR_DT
							},
							callback : function(records, operation, success) {
								store.reload();
								
								Ext.toast({
									title: ' ',
									timeout: 1000,
									html: '입고등록완료',
									style: 'text-align: center',
									align: 't',
									width: 130,
								});
								
							}
						});
					
    			}
    		});
    		} else {
				Ext.Msg.alert('확인', msg);
			}
    	} else {
    		Ext.Msg.alert('확인', '등록할 내역을 선택하세요.');
    	}
    },

});
