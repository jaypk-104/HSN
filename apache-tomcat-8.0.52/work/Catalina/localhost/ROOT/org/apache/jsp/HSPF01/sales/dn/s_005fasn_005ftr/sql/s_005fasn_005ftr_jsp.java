/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/8.0.52
 * Generated at: 2021-03-04 02:11:36 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp.HSPF01.sales.dn.s_005fasn_005ftr.sql;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import HSPLATFORM.DbConn;
import org.json.simple.JSONArray;
import org.json.simple.JSONValue;
import net.sf.json.JSONObject;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.net.URLDecoder;
import java.util.HashMap;
import java.net.URL;
import java.net.URLConnection;
import java.io.OutputStreamWriter;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import org.apache.commons.lang.StringUtils;
import java.sql.*;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.sql.DataSource;
import java.io.File;
import java.io.InputStream;
import java.io.FileInputStream;
import org.apache.commons.net.PrintCommandListener;
import org.apache.commons.net.ftp.FTP;
import org.apache.commons.net.ftp.FTPClient;
import org.apache.commons.net.ftp.FTPReply;
import com.jcraft.jsch.Channel;
import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.JSchException;
import com.jcraft.jsch.Session;
import com.jcraft.jsch.SftpException;

public final class s_005fasn_005ftr_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  static {
    _jspx_dependants = new java.util.HashMap<java.lang.String,java.lang.Long>(1);
    _jspx_dependants.put("/HSPF01/common/DB_Connection.jsp", Long.valueOf(1551915626000L));
  }

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.HashSet<>();
    _jspx_imports_packages.add("java.sql");
    _jspx_imports_packages.add("javax.servlet");
    _jspx_imports_packages.add("javax.servlet.http");
    _jspx_imports_packages.add("javax.servlet.jsp");
    _jspx_imports_classes = new java.util.HashSet<>();
    _jspx_imports_classes.add("com.jcraft.jsch.Channel");
    _jspx_imports_classes.add("org.apache.commons.lang.StringUtils");
    _jspx_imports_classes.add("java.net.URLDecoder");
    _jspx_imports_classes.add("org.apache.commons.net.ftp.FTP");
    _jspx_imports_classes.add("com.jcraft.jsch.JSch");
    _jspx_imports_classes.add("java.net.URL");
    _jspx_imports_classes.add("java.util.HashMap");
    _jspx_imports_classes.add("javax.naming.NamingException");
    _jspx_imports_classes.add("org.json.simple.JSONArray");
    _jspx_imports_classes.add("org.apache.commons.net.PrintCommandListener");
    _jspx_imports_classes.add("HSPLATFORM.DbConn");
    _jspx_imports_classes.add("org.json.simple.JSONValue");
    _jspx_imports_classes.add("java.net.URLConnection");
    _jspx_imports_classes.add("com.jcraft.jsch.SftpException");
    _jspx_imports_classes.add("javax.sql.DataSource");
    _jspx_imports_classes.add("java.io.OutputStreamWriter");
    _jspx_imports_classes.add("org.apache.commons.net.ftp.FTPClient");
    _jspx_imports_classes.add("javax.naming.Context");
    _jspx_imports_classes.add("com.jcraft.jsch.ChannelSftp");
    _jspx_imports_classes.add("java.io.PrintWriter");
    _jspx_imports_classes.add("javax.naming.InitialContext");
    _jspx_imports_classes.add("java.io.StringWriter");
    _jspx_imports_classes.add("java.io.FileInputStream");
    _jspx_imports_classes.add("java.io.InputStreamReader");
    _jspx_imports_classes.add("java.io.File");
    _jspx_imports_classes.add("com.jcraft.jsch.Session");
    _jspx_imports_classes.add("net.sf.json.JSONObject");
    _jspx_imports_classes.add("java.io.BufferedReader");
    _jspx_imports_classes.add("com.jcraft.jsch.JSchException");
    _jspx_imports_classes.add("java.io.InputStream");
    _jspx_imports_classes.add("org.apache.commons.net.ftp.FTPReply");
  }

  private volatile javax.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public javax.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

final java.lang.String _jspx_method = request.getMethod();
if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method) && !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET POST or HEAD");
return;
}

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");

	Connection conn = null;
	PreparedStatement pstmt = null;
	Statement stmt = null;

	try {
		Context initCtx = new InitialContext();
		Context envCtx = (Context) initCtx.lookup("java:comp/env");
		DataSource dataSource = (DataSource) envCtx.lookup("jdbc/Tibero");
		conn = dataSource.getConnection();
		stmt = conn.createStatement();

	} catch (NamingException e) {

	}

      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");

	request.setCharacterEncoding("utf-8");
	ResultSet rs = null;
	CallableStatement cs = null;
	JSONObject jsonObject = new JSONObject();
	JSONArray jsonArray = new JSONArray();
	JSONObject subObject = null;

	try {
		String V_TYPE = request.getParameter("V_TYPE") == null ? "" : request.getParameter("V_TYPE");
		String V_COMP_ID = request.getParameter("V_COMP_ID") == null ? "" : request.getParameter("V_COMP_ID").toUpperCase();
		String V_USR_ID = request.getParameter("V_USR_ID") == null ? "" : request.getParameter("V_USR_ID").toUpperCase();

		// 		System.out.println("V_CUST_ORDER_NO :" + V_CUST_ORDER_NO);

		if (V_TYPE.equals("S")) {
			String V_DN_DT_FROM = request.getParameter("V_DN_DT_FROM") == null ? "" : request.getParameter("V_DN_DT_FROM").toUpperCase();
			String V_DN_DT_TO = request.getParameter("V_DN_DT_TO") == null ? "" : request.getParameter("V_DN_DT_TO").toUpperCase();
			String V_BL_DOC_NO = request.getParameter("V_BL_DOC_NO") == null ? "" : request.getParameter("V_BL_DOC_NO").toUpperCase();
			String V_ITEM_NM = request.getParameter("V_ITEM_NM") == null ? "" : request.getParameter("V_ITEM_NM").toUpperCase();
			
			if(V_DN_DT_FROM.length() > 10){
				V_DN_DT_FROM = V_DN_DT_FROM.substring(0,10);
			}
			if(V_DN_DT_TO.length() > 10){
				V_DN_DT_TO = V_DN_DT_TO.substring(0,10);
			}
			
			cs = conn.prepareCall("call USP_S_ASN_TR_HSPF(?,?,?,?,?,?,?)");
			cs.registerOutParameter(1, com.tmax.tibero.TbTypes.CURSOR);
			cs.setString(2, V_COMP_ID);//V_COMP_ID
			cs.setString(3, V_TYPE);//V_TYPE
			cs.setString(4, V_DN_DT_FROM);//V_DN_DT_FROM
			cs.setString(5, V_DN_DT_TO);//
			cs.setString(6, V_BL_DOC_NO);//V_BL_DOC_NO
			cs.setString(7, V_ITEM_NM);//V_ITEM_NM
			
			cs.executeQuery();

			rs = (ResultSet) cs.getObject(1);
			while (rs.next()) {
				subObject = new JSONObject();
				subObject.put("S_BP_NM", rs.getString("S_BP_NM"));
				subObject.put("BL_NO", rs.getString("BL_NO"));
				subObject.put("DLVY_HOPE_DT", rs.getString("DLVY_HOPE_DT"));
				subObject.put("DN_DT", rs.getString("DN_DT"));
				subObject.put("M_BP_NM", rs.getString("M_BP_NM"));
				subObject.put("BP_ITEM_CD", rs.getString("BP_ITEM_CD"));
				subObject.put("ITEM_NM", rs.getString("ITEM_NM"));
				subObject.put("SPEC", rs.getString("SPEC"));
				subObject.put("UNIT", rs.getString("UNIT"));
				subObject.put("DN_QTY", rs.getString("DN_QTY"));
				subObject.put("SUPP_REMARK", rs.getString("SUPP_REMARK"));
				subObject.put("REMARK", rs.getString("REMARK"));
				subObject.put("IF_SRM_YN", rs.getString("IF_SRM_YN"));
				subObject.put("DN_NO", rs.getString("DN_NO"));
				jsonArray.add(subObject);

			}

			jsonObject.put("success", true);
			jsonObject.put("resultList", jsonArray);

			// 			System.out.println(jsonObject);
			response.setContentType("text/plain; charset=UTF-8");
			PrintWriter pw = response.getWriter();
			pw.print(jsonObject);
			pw.flush();
			pw.close();
		} 
		if (V_TYPE.equals("IF")) {
			
			/*
			String SQL = "";
			SQL =       "SELECT 'ATHS'|| SUBSTR(A.DN_NO, 3) ASN_NO, B.LOT_NO                                                                                                               ";
			SQL +=      "    , 'S001_ATHS'|| SUBSTR(A.DN_NO, 3) || '_' || TO_CHAR(SYSDATE, 'YYYYMMDD_HH24MISS') || SUBSTR( C.FILE_IN_SYSTEM_NM, INSTR(C.FILE_IN_SYSTEM_NM, '.')) TR_FILE_NM";
			SQL +=      "    , C.FILE_NM                                                                                                                                                   ";
			SQL +=      "    , C.FILE_IN_SYSTEM_NM                                                                                                                                         ";
			SQL +=      "FROM S_DN_DIREC_BC_SWM A                                                                                                                                          ";
			SQL +=      "LEFT OUTER JOIN SCM_BARCD_DTL_SWM B ON A.PAL_BC_NO = B.PAL_BC_NO AND A.BOX_BC_NO = B.BOX_BC_NO AND A.LOT_BC_NO = B.LOT_BC_NO                                      ";
			SQL +=      "LEFT OUTER JOIN SCM_ASN_FILE_HSPF C ON B.ASN_NO = C.ASN_NO                                                                                                        ";
			SQL +=      "WHERE A.BP_CD = '04716'                                                                                                                                           ";
			SQL +=      "AND C.FILE_NM IS NOT NULL                                                                                                                                         ";
			SQL +=      "AND NVL(A.IF_SRM_YN,'N') = 'N'                                                                                                                                    ";
			SQL +=      "GROUP BY SUBSTR(A.DN_NO, 3), B.LOT_NO, C.FILE_NM, C.FILE_IN_SYSTEM_NM;                                                                                            ";
			
			rs = stmt.executeQuery(SQL);
			*/
			
			cs = conn.prepareCall("call USP_S_DN_HSTN_FILE_LOG(?,?)");
			cs.registerOutParameter(1, com.tmax.tibero.TbTypes.CURSOR);
			cs.setString(2, V_USR_ID);
			cs.executeQuery();
			rs = (ResultSet) cs.getObject(1);
			
			while (rs.next()) {
				
				File file = new File("/data/HSPF01/" + rs.getString("FILE_IN_SYSTEM_NM"));

				FTPClient ftpClient = new FTPClient();

				ftpClient.setControlEncoding("utf-8");
				String server = "43.254.152.57";  //파일 업로드 할 서버 IP
				int port = 1999;  //파일 업로드 할 서버 포트
			    String username = "hstn_ko";       //사용자 Id
			    String password = "hstnkorea";       //패스워드
//				    String defaultPath = "C:\\OmegaPlus\\upload\\default\\AsnQcUploadFile\\";     // 저장할 경로
//				    String defaultPath = "/";     // 저장할 경로
//					String server = "123.142.124.170";  //파일 업로드 할 서버 IP
//					int port = 21;  //파일 업로드 할 서버 포트
//				    String username = "root";       //사용자 Id
//				    String password = "!qa2ws3ed";       //패스워드
//				    String defaultPath = "/data";     // 저장할 경로

			    ftpClient.connect(server,port);
			    int reply = ftpClient.getReplyCode();
			    
			    if (!FTPReply.isPositiveCompletion(reply)) {
			    	ftpClient.disconnect();
		            throw new Exception("Exception in connecting to FTP Server");
		        }
			    ftpClient.login(username, password);//로그인
			    ftpClient.setFileType(FTP.BINARY_FILE_TYPE);
			    ftpClient.enterLocalPassiveMode();
				
			    InputStream input = new FileInputStream(file);

			    ftpClient.storeFile(rs.getString("TR_FILE_NM"), input);
			    
			    ftpClient.disconnect();
			    
			    
			    
			    /*
			    //여기는 SFTP 방식
			    Session F_session = null;
			    Channel F_channel = null;
			    ChannelSftp F_channelSftp = null;

			    String url = "123.142.124.170"; 
			    String user = "root"; 
			    String password = "!qa2ws3ed";
				String defaultPath = "/data";     // 저장할 경로
//				    String url = "43.254.152.57"; 
//				    String user = "hstn_ko"; 
//				    String password = "hstnkorea";
//				    String defaultPath = "C:\\OmegaPlus\\upload\\default\\AsnQcUploadFile\\";     // 저장할 경로


			    
			    JSch jsch = new JSch();
			    
			    F_session = jsch.getSession(user, url);
			    F_session.setPassword(password);
			    //세션관련 설정정보 설정 
			    java.util.Properties F_config = new java.util.Properties(); 
			    
			    //호스트 정보 검사하지 않는다. 
			    F_config.put("StrictHostKeyChecking", "no"); 
			    F_session.setConfig(F_config); 
			    
			    //접속 
			    F_session.connect(); 
			    
			    //sftp 채널 접속 
			    F_channel = F_session.openChannel("sftp"); 
			    F_channel.connect();
			    
			    F_channelSftp = (ChannelSftp) F_channel;

			    FileInputStream F_in = null;
			    
			    F_in = new FileInputStream(file);
			    F_channelSftp.cd(defaultPath);
			    F_channelSftp.put(F_in,file.getName());

			    F_channelSftp.quit(); 
			    F_session.disconnect();
				*/
				
				
			}
				
			
			
			
		
			URL url1 = new URL("http://123.142.124.155:8088/http/hsn_hstn_asn");
			URLConnection con = url1.openConnection();
			con.setRequestProperty("Accept-Language", "ko-kr,ko;q=0.8,en-us;q=0.5,en;q=0.3");
			con.setDoOutput(true);
			JSONObject anySubObject = new JSONObject();

// 			anySubObject.put("V_DN_NO", "1");
// 			anySubObject.put("V_DN_SEQ", "1");
			anySubObject.put("V_COMP_ID", "HSN");
			anySubObject.put("V_USR_ID", V_USR_ID);
			JSONArray anyArray = new JSONArray();
			anyArray.add(anySubObject);
			JSONObject anyObject = new JSONObject();
			anyObject.put("data", anyArray);
			String parameter = anyObject + "";

			// 			System.out.println(parameter);
			OutputStreamWriter wr = new OutputStreamWriter(con.getOutputStream());
			wr.write(parameter);
			wr.flush();
			BufferedReader rd = null;
			rd = new BufferedReader(new InputStreamReader(con.getInputStream(), "UTF-8"));
			String line = null;
			String result = null;
			while ((line = rd.readLine()) != null) {
				result = URLDecoder.decode(line, "UTF-8");
			}
			//                   System.out.println(result);
			response.setContentType("text/plain; charset=UTF-8");
			PrintWriter pw = response.getWriter();
			pw.print(result);
			pw.flush();
			pw.close();
			
			
		}
		

	} catch (Exception e) {
		e.printStackTrace();
	} finally {
		if (cs != null) try {
			cs.close();
		} catch (SQLException ex) {}
		if (rs != null) try {
			rs.close();
		} catch (SQLException ex) {}
		if (stmt != null) try {
			stmt.close();
		} catch (SQLException ex) {}
		if (conn != null) try {
			conn.close();
		} catch (SQLException ex) {}
	}

      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
