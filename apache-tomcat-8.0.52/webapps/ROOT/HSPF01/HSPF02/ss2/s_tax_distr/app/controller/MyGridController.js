/*
 * File: app/controller/MyGridController.js
 *
 * This file was generated by Sencha Architect version 4.2.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('S_TAX_DISTR.controller.MyGridController', {
	extend : 'Ext.app.Controller',
	stores : [ 'MyStore', 'MyStore1' ],
	control : {
		"#xlsxDown" : {
			click : 'xlsxDown1Click'
		},
		"#xlsxDown1" : {
			click : 'xlsxDown1Click'
		},
		"#cfmBtn" : {
			click : 'cfmBtnClick'
		},
		"#gridDelBtn" : {
			click : 'gridDelBtnClick'
		},
	},
	
	cfmBtnClick: function(button, e, eOpts) {
    	var store = Ext.getStore('MyStore');
		var store1 = Ext.getStore('MyStore1');
		var gridRecord = Ext.getCmp('myGrid').getSelectionModel().getSelection();
		var flag = '';
		var msg = '';
    	
    	if (Ext.getCmp('V_ISSUED_DT').getValue() == null) {
			flag = 'F';
			msg = '발행일자를 입력하세요.';
		} else if (Ext.getCmp('V_BIZ_AREA_CD').getValue() == null) {
			flag = 'F';
			msg = '세금계산서 신고사업장을 선택하세요.';
		} else if (Ext.getCmp('V_TAX_BILL_TYPE').getValue() == null) {
			flag = 'F';
			msg = '매출채권형태를 선택하세요.';
		} else if (Ext.getCmp('V_VAT_TYPE').getValue() == null) {
			flag = 'F';
			msg = '부가세유형을 선택하세요.';
		} else {
			flag = 'T';
		}
    	if(flag == 'T') {
    	Ext.Msg.confirm('확인', '세금계산서를 등록하시겠습니까?', function(button) {
			if (button == 'yes') {
	    		if(Ext.getCmp('V_TAX_BILL_NO').getValue() == '') {
	    			Ext.Ajax.request({
	        			url : 'sql/S_TAX_DISTR.jsp',
	        			method : 'post',
	        			params: {
	        				V_TYPE: 'IH',
	            			V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
	        				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
	        				V_ISSUED_DT : Ext.getCmp('V_ISSUED_DT').getValue(),
	        				V_TAX_BILL_TYPE : Ext.getCmp('V_TAX_BILL_TYPE').getValue(),
	        				V_BIZ_AREA_CD : Ext.getCmp('V_BIZ_AREA_CD').getValue(),
	        				V_TAX_DOC_NO : Ext.getCmp('V_TAX_DOC_NO').getValue(),
	        				V_VAT_TYPE : Ext.getCmp('V_VAT_TYPE').getValue(),
	        				V_VAT_RATE : Ext.getCmp('V_VAT_RATE').getValue(),
	        				V_NET_AMT : Ext.getCmp('V_NET_AMT').getValue(),
	        				V_VAT_AMT : Ext.getCmp('V_VAT_AMT').getValue(),
	        				V_NET_LOC_AMT : Ext.getCmp('V_NET_LOC_AMT').getValue(),
	        				V_TOTAL_AMT : Ext.getCmp('V_TOTAL_AMT').getValue(),
	        				V_S_BP_CD : Ext.getCmp('V_S_BP_CD2').getValue(),
	        			},
	        			success: function(response) {
	        				var res = response.responseText;
	        				var jsonResult = Ext.JSON.decode(response.responseText);
//	        				console.log(jsonResult);
	        				
	        				store1.each(function(record, idx) {
	    						record.set('V_TYPE', 'I');
	        				});
	        				
	        				// 정상등록
	        				if(!res.match('Exception')) {
	        					Ext.getCmp('V_TAX_BILL_NO').setValue(jsonResult.TAX_NO);
	        					Ext.getCmp('V_TAX_DOC_NO').setValue(jsonResult.TAX_DOC_NO);
	        					
	        					store1.sync({ 
	        						params : {
	        							V_TYPE : 'SYNC',
	        							V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
	        							V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
	        							V_TAX_BILL_NO : jsonResult.TAX_NO,
	        							V_TAX_DOC_NO : jsonResult.TAX_DOC_NO,
	        	        				V_ISSUED_DT : Ext.getCmp('V_ISSUED_DT').getValue(),
	        						},
	        						callback : function(records, operation, success) {
	        				    		var tbController = S_TAX_DISTR.app.getController("TbButtonController");
	        				    		tbController.selBtnClick();
	        						}, 
	        						success: function() {
	        							
	        						}
	        					});
	        				} else {
	        					Ext.Msg.alert('확인', res);
	        				}
	        			}
	            	});
	    		} else {

	    			Ext.Ajax.request({
	        			url : 'sql/S_TAX_DISTR.jsp',
	        			method : 'post',
	        			params: {
	        				V_TYPE: 'UH',
	        				V_TAX_BILL_NO : Ext.getCmp('V_TAX_BILL_NO').getValue(),
	            			V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
	        				V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
	        				V_ISSUED_DT : Ext.getCmp('V_ISSUED_DT').getValue(),
	        				V_TAX_BILL_TYPE : Ext.getCmp('V_TAX_BILL_TYPE').getValue(),
	        				V_BIZ_AREA_CD : Ext.getCmp('V_BIZ_AREA_CD').getValue(),
	        				V_TAX_DOC_NO : Ext.getCmp('V_TAX_DOC_NO').getValue(),
	        				V_VAT_TYPE : Ext.getCmp('V_VAT_TYPE').getValue(),
	        				V_VAT_RATE : Ext.getCmp('V_VAT_RATE').getValue(),
	        				V_NET_AMT : Ext.getCmp('V_NET_AMT').getValue(),
	        				V_VAT_AMT : Ext.getCmp('V_VAT_AMT').getValue(),
	        				V_NET_LOC_AMT : Ext.getCmp('V_NET_LOC_AMT').getValue(),
	        				V_TOTAL_AMT : Ext.getCmp('V_TOTAL_AMT').getValue(),
	        				V_S_BP_CD : Ext.getCmp('V_S_BP_CD2').getValue(),
	        			},
	        			success: function(response) {
	        				store1.each(function(record, idx) {
	    						record.set('V_TYPE', 'U');
	        				});
	        				
	        				// 정상등록
	        					Ext.getCmp('V_TAX_BILL_NO').setValue(jsonResult.TAX_NO);
	        					Ext.getCmp('V_TAX_DOC_NO').setValue(jsonResult.TAX_DOC_NO);
	        					
	        					store1.sync({ 
	        						params : {
	        							V_TYPE : 'SYNC',
	        							V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
	        							V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
	        							V_TAX_BILL_NO : Ext.getcmp('V_TAX_BILL_NO').getValue(),
	        							V_TAX_DOC_NO : Ext.getCmp('V_TAX_DOC_NO').getValue(),
	        	        				V_ISSUED_DT : Ext.getCmp('V_ISSUED_DT').getValue(),
	        						},
	        						callback : function(records, operation, success) {
	        				    		var tbController = S_TAX_DISTR.app.getController("TbButtonController");
	        				    		tbController.selBtnClick();
	        						}, 
	        						success: function() {
	        							
	        						}
	        					});
	        			}
	            	});
	    		
	    		}
			    		
			    	} 
    	
    	});
    	} else {
    		Ext.Msg.alert('확인', msg);
    	}
	},
	
gridDelBtnClick : function(button, e, eOpts) {
		
		var store = Ext.getStore('MyStore');
		var store1 = Ext.getStore('MyStore1');
		var flag = '';
		var msg = '';
		
		var gridRecord1 = Ext.getCmp('myGrid1').getSelectionModel().getSelection();
		
		Ext.Msg.confirm('확인', '삭제하시겠습니까?', function(button) {
			if (button == 'yes') {

				var gridRecord = Ext.getCmp('myGrid').getSelectionModel().getSelection();
				var gridRecord1 = Ext.getCmp('myGrid1').getSelectionModel().getSelection();

				for(var i=0; i<gridRecord1.length; i++) {
					if(gridRecord1[i].get('V_TYPE') == 'V') {
						gridRecord1[i].set('V_TYPE', 'D');
					}
				}
				
				store1.sync({
					params : {
						V_TYPE : 'SYNC',
						V_COMP_ID : parent.Ext.getCmp('GCOMP_ID').getValue(),
						V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
						V_TAX_BILL_NO: Ext.getCmp('V_TAX_BILL_NO').getValue()
					},
					callback : function(records, operation, success) {
						store.reload();
						store1.reload();
						
						if(store1.getCount() == gridRecord1.length) {

					    	Ext.getCmp('V_TAX_BILL_NO').setValue('');
					    	Ext.getCmp('V_TAX_DOC_NO').setValue('');
					    	
					    	Ext.getCmp('V_S_BP_CD2').setValue('');
							Ext.getCmp('V_S_BP_NM2').setValue('');
					    	
							var nows = new Date();
					//
							Ext.getCmp('V_ISSUED_DT').setValue(nows);
							Ext.getCmp('V_TAX_BILL_TYPE').setValue('DSO');
							Ext.getCmp('V_BIZ_AREA_CD').setValue('TX3');
							Ext.getCmp('V_VAT_TYPE').setValue('K');
							Ext.getCmp('V_VAT_AMT').setValue('0');
							Ext.getCmp('V_NET_AMT').setValue('0');
							Ext.getCmp('V_NET_LOC_AMT').setValue('0');
							Ext.getCmp('V_TOTAL_AMT').setValue('0');
//							
							Ext.getCmp('tempGlCfmBtn').setDisabled(true);
							Ext.getCmp('tempGlCancelBtn').setDisabled(true);
						}
					}, 
					success: function() {
					}
				});
			}
		});
	},
	
	xlsxDown1Click: function(button, e, eOpts) {
        var currentDate = Ext.util.Format.date(new Date(), 'Y-m-d His');
            	var grid = Ext.getCmp('myGrid1');
            	grid.saveDocumentAs({
                    type: 'xlsx',
                    title: '매출채권등록상세', //엑셀내타이틀
                    fileName: currentDate+'.xlsx' //엑셀파일이름
        		});
    }
});
