/*
 * File: app/controller/ReplyWindowController.js
 *
 * This file was generated by Sencha Architect version 4.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('HSPF_BOARD.controller.ReplyWindowController', {
    extend: 'Ext.app.Controller',

    control: {
        "#W_replyCfmBtn": {
            click: 'W_replyCfmBtnClick'
        },
        "#W_cancelBtn": {
            click: 'W_cancelBtnClick'
        }
    },

    W_replyCfmBtnClick: function(button, e, eOpts) {
        var store = this.getStore('ReplyStore');
        var REPLY_TEXT = Ext.getCmp('W_REPLY_TEXT').getValue();

        Ext.Msg.confirm('확인', '댓글 등록 하시겠습니까?', function(btn) {
            if (btn == 'yes') {
                Ext.Ajax.request({
                    url:'sql/board_reply.jsp',
                    method: 'post',
                    params: {
                        V_COMP_ID : 'HSN',
                        V_TYPE: 'RE_I',
                        V_IDX_NUM : Ext.getCmp('V_IDX_NUM').getValue(),
                        V_REPLY_TEXT : Ext.getCmp('W_REPLY_TEXT').getValue(),
                        V_REF_IDX : Ext.getCmp('W_REF_IDX').getValue(),
                        V_PARENT_REPLY_IDX : Ext.getCmp('W_PARENT_REPLY_IDX').getValue(),
                        V_REPLY_LEVEL : Ext.getCmp('W_REPLY_LEVEL').getValue(),
                        V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
                    },

                    success : function(response) {
                        Ext.Ajax.request({
                            url : '/HSPF01/common/MailingService_board.jsp',
                            method : 'post',
                            params : {
                                V_COMP_ID : 'HSN',
                                V_TYPE: 'RE_EMAIL_YN',
                                V_IDX_NUM : Ext.getCmp('V_IDX_NUM').getValue(),
                                V_PARENT_REPLY_IDX : Ext.getCmp('W_PARENT_REPLY_IDX').getValue(),
                                V_USR_ID : parent.Ext.getCmp('GUSER_ID').getValue(),
                            },
                            success: function(response) {
                                var jsonResult = Ext.JSON.decode(response.responseText);
                                var length = jsonResult.resultList.length;
                                for(var i = 0; i < length; i++) {
                                    // 이메일 수신여부가 Y이면
                                    if(jsonResult.resultList[i].EMAIL_YN == 'Y') {
                                        var email = jsonResult.resultList[i].EMAIL;
                                        Ext.Ajax.request({
                                            url : '/HSPF01/common/MailingService_board.jsp',
                                            method : 'post',
                                            params : {
                                                V_COMP_ID : 'HSN',
                                                V_TYPE: 'EMAIL_SEND',
                                                V_TYPE2 : 'REPLY',
                                                V_EMAIL: email,
                                                V_TITLE : Ext.getCmp('V_BOARD_TITLE').getValue(),
                                                V_REPLY_TEXT : REPLY_TEXT,
                                            },
                                            success: function(response) {
                                            },
                                            scope : this
                                        });
                                    }
                                }
                            },
                            scope : this
                        });

                        store.reload();
                        Ext.getCmp('replyWindow').destroy();


                    },
                    scope: this
                });
            }
        });
    },

    W_cancelBtnClick: function(button, e, eOpts) {
        Ext.getCmp('replyWindow').destroy();
    }

});
